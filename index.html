<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Somar Express - Delivery</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    .brand-orange { color: #FF8C00; }
    .bg-brand-orange { background-color: #FF8C00; }
    .brand-black { color: #1A1A1A; }
    .bg-brand-black { background-color: #1A1A1A; }
    
    .loading-screen {
      background: linear-gradient(135deg, #FF8C00 0%, #FF6B00 100%);
    }
    
    .loading-logo {
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
    }
    
    .loading {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #FFFFFF;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .skeleton-text {
      height: 12px;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    
    .skeleton-card {
      border-radius: 16px;
      overflow: hidden;
    }
    
    .carousel-container {
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    
    .carousel-container::-webkit-scrollbar { display: none; }
    
    .carousel-item {
      scroll-snap-align: start;
      flex-shrink: 0;
    }
    
    .carousel-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #D1D5DB;
      transition: all 0.3s;
    }
    
    .carousel-dot.active {
      background: #FF8C00;
      width: 24px;
      border-radius: 4px;
    }
    
    .offers-banner {
      background: linear-gradient(90deg, #FF8C00, #FF6B00, #FF8C00);
      background-size: 200% 100%;
      animation: gradient-shift 3s ease infinite;
      overflow: hidden;
    }
    
    @keyframes gradient-shift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    .offers-scroll {
      display: flex;
      animation: scroll-left 20s linear infinite;
      white-space: nowrap;
    }
    
    @keyframes scroll-left {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    
    .fade-in {
      animation: fadeIn 0.4s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .distance-badge {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
    }
  </style>
</head>
<body class="bg-gray-50">
  <header class="bg-white sticky top-0 z-50 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-3 text-brand-black">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="https://res.cloudinary.com/drkaxsziu/image/upload/v1767871213/Somar_Express_2048_x_2048_px_18_x_18_in__20250623_221102_0000_o0bv7a.png" alt="Somar Express" class="w-12 h-12 object-contain">
          <div>
            <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">Entregar en</p>
            <button id="locationBtn" class="text-sm font-bold flex items-center gap-1 hover:text-brand-orange transition">
              <svg class="w-4 h-4 text-brand-orange" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
              </svg>
              <span id="locationText">Detectando...</span>
            </button>
          </div>
        </div>
        
        <button id="cartBtn" class="relative p-2 bg-gray-50 rounded-full">
          <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
          </svg>
          <span id="cartCount" class="absolute -top-1 -right-1 bg-brand-orange text-white text-[10px] font-black rounded-full w-5 h-5 flex items-center justify-center border-2 border-white">0</span>
        </button>
      </div>
    </div>
  </header>

  <div class="offers-banner text-white py-2 text-xs uppercase tracking-tighter">
    <div class="offers-scroll">
      <div class="flex items-center gap-8 px-4 font-black">
        <span>üéâ Env√≠o Gratis pedidos > L.300</span>
        <span>‚ö° Delivery Express 30 min</span>
        <span>üí∞ Ofertas todos los d√≠as</span>
        <span>üÜï Nuevos comercios disponibles</span>
      </div>
      <div class="flex items-center gap-8 px-4 font-black">
        <span>üéâ Env√≠o Gratis pedidos > L.300</span>
        <span>‚ö° Delivery Express 30 min</span>
        <span>üí∞ Ofertas todos los d√≠as</span>
        <span>üÜï Nuevos comercios disponibles</span>
      </div>
    </div>
  </div>

  <div id="loading" class="loading-screen fixed inset-0 z-[100] flex flex-col justify-center items-center">
    <img src="https://res.cloudinary.com/drkaxsziu/image/upload/v1767871112/Somar_Express_2048_x_2048_px_18_x_18_in__20250623_221144_0000_fcsl1b.png" alt="Somar Express" class="loading-logo w-40 h-40 mb-6">
    <div class="loading"></div>
    <p class="text-white mt-4 font-black uppercase text-sm tracking-widest">Iniciando App...</p>
  </div>

  <section id="categoriasSection" class="hidden pb-20">
    <div class="bg-white pb-6 shadow-sm">
      <div class="carousel-container flex overflow-x-auto snap-x snap-mandatory px-4 gap-3 pt-4" id="bannerCarousel"></div>
      <div class="carousel-dots mt-4" id="carouselDots"></div>
    </div>

    <div class="max-w-7xl mx-auto px-4 mt-8">
      <h2 class="text-xl font-black mb-6 uppercase tracking-tight">¬øQu√© pedimos hoy?</h2>
      <div id="categoriasList" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
      <div id="categoriasLoader" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 hidden">
        <div class="skeleton h-24 rounded-2xl"></div>
        <div class="skeleton h-24 rounded-2xl"></div>
        <div class="skeleton h-24 rounded-2xl"></div>
      </div>
    </div>
  </section>

  <section id="comerciosSection" class="hidden min-h-screen bg-gray-50">
    <div class="bg-white sticky top-[72px] z-40 shadow-sm border-t border-gray-100">
      <div class="max-w-7xl mx-auto px-4 py-3">
        <button id="backToCategorias" class="flex items-center gap-1 text-gray-400 font-bold text-xs uppercase mb-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
          Categor√≠as
        </button>
        <h2 id="categoriaTitulo" class="text-2xl font-black mb-4"></h2>
        
        <div class="flex gap-2">
          <div class="relative flex-1">
            <input type="text" id="searchComercio" placeholder="Buscar..." class="w-full bg-gray-100 border-none rounded-xl px-4 py-3 pl-10 focus:ring-2 focus:ring-brand-orange focus:bg-white transition text-sm">
            <svg class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </div>
          <select id="sortComercio" class="bg-gray-100 border-none rounded-xl px-3 py-3 text-xs font-bold uppercase focus:ring-2 focus:ring-brand-orange">
            <option value="default">Ordenar</option>
            <option value="distance">M√°s cercanos</option>
            <option value="name">Nombre</option>
          </select>
        </div>
      </div>
    </div>
    
    <div class="max-w-7xl mx-auto px-4 py-6">
      <div id="comerciosList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      <div id="comerciosLoader" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="skeleton h-48 rounded-3xl"></div>
        <div class="skeleton h-48 rounded-3xl"></div>
      </div>
    </div>
  </section>

  <section id="productosSection" class="hidden min-h-screen bg-gray-50">
    <div class="bg-white border-b border-gray-100">
      <div class="max-w-7xl mx-auto px-4 py-4">
        <button id="backBtn" class="flex items-center gap-1 text-gray-400 font-bold text-xs uppercase mb-4">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
          Comercios
        </button>
        <div id="comercioHeader" class="mb-2"></div>
        <input type="text" id="searchProducto" placeholder="¬øQu√© se te antoja?" class="w-full bg-gray-100 border-none rounded-xl px-4 py-3 focus:ring-2 focus:ring-brand-orange transition text-sm">
      </div>
    </div>
    
    <div class="max-w-7xl mx-auto px-4 py-6">
      <div id="productosList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      <div id="productosLoader" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="skeleton h-32 rounded-2xl"></div>
      </div>
      <button id="customProductBtn" class="mt-8 w-full bg-white border-2 border-dashed border-gray-300 py-4 rounded-2xl font-bold text-gray-400 hover:border-brand-orange hover:text-brand-orange transition flex items-center justify-center gap-2">
        <span>‚ûï</span> No encuentro lo que busco
      </button>
    </div>
  </section>

  <div id="cartModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-end sm:items-center justify-center">
    <div class="bg-white rounded-t-[32px] sm:rounded-3xl w-full max-w-lg max-h-[85vh] flex flex-col overflow-hidden animate-slide-up">
      <div class="p-6 border-b flex justify-between items-center">
        <h2 class="text-2xl font-black">Tu Carrito</h2>
        <button id="closeCartBtn" class="bg-gray-100 p-2 rounded-full"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
      </div>
      <div id="cartItems" class="flex-1 overflow-y-auto p-6"></div>
      <div class="p-6 bg-gray-50 border-t">
        <div class="flex justify-between items-center mb-6">
          <span class="font-bold text-gray-500 uppercase text-xs tracking-widest">Total a pagar</span>
          <span class="text-3xl font-black brand-orange">L.<span id="cartTotal">0</span></span>
        </div>
        <button id="checkoutBtn" class="w-full bg-brand-orange text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-xl shadow-orange-200 hover:scale-[1.02] active:scale-95 transition">Continuar</button>
      </div>
    </div>
  </div>

  <div id="checkoutModal" class="hidden fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4">
    <div class="bg-white rounded-[32px] w-full max-w-md p-8 animate-scale-in">
      <h2 class="text-2xl font-black mb-6">Entrega</h2>
      <form id="checkoutForm" class="space-y-4">
        <div>
          <label class="block text-[10px] font-black uppercase text-gray-400 mb-1">Tu Celular</label>
          <input type="tel" id="celular" required placeholder="9999-9999" class="w-full bg-gray-100 border-none rounded-xl p-4 focus:ring-2 focus:ring-brand-orange">
        </div>
        <div>
          <label class="block text-[10px] font-black uppercase text-gray-400 mb-1">Referencia de Direcci√≥n</label>
          <textarea id="direccion" required placeholder="Ej: Port√≥n negro frente a la escuela..." class="w-full bg-gray-100 border-none rounded-xl p-4 focus:ring-2 focus:ring-brand-orange" rows="3"></textarea>
        </div>
        <div class="flex gap-3 pt-4">
          <button type="button" id="cancelCheckoutBtn" class="flex-1 font-bold text-gray-400 py-4">Atr√°s</button>
          <button type="submit" class="flex-[2] bg-brand-orange text-white rounded-2xl font-black uppercase tracking-widest py-4 shadow-lg shadow-orange-200">Pedir Ya</button>
        </div>
      </form>
    </div>
  </div>

  <div id="customProductModal" class="hidden fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4">
    <div class="bg-white rounded-[32px] w-full max-w-md p-8">
      <h2 class="text-xl font-black mb-6 uppercase">Producto Especial</h2>
      <form id="customProductForm" class="space-y-4">
        <input type="text" id="customName" placeholder="¬øQu√© necesitas?" required class="w-full bg-gray-100 border-none rounded-xl p-4">
        <input type="number" id="customPrice" placeholder="Precio aprox. L." required class="w-full bg-gray-100 border-none rounded-xl p-4">
        <div class="flex gap-3 pt-4">
          <button type="button" id="cancelCustomBtn" class="flex-1 font-bold text-gray-400">Cancelar</button>
          <button type="submit" class="flex-[2] bg-brand-orange text-white rounded-2xl font-black py-4">Agregar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // URL del Google Apps Script
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxzmnCMSGJOo5cjFB424vQ-6jNRRBQKWS3wVJlw4U-f3e_7utcXCgWf3zdrEtEFKPhL-g/exec';
    
    let appData = {
      comercios: [],
      categorias: [],
      productos: [],
      cart: [],
      currentComercio: null,
      selectedCategoria: null,
      userLocation: null,
      userAddress: 'Ubicaci√≥n no detectada',
      searchTermComercio: '',
      searchTermProducto: '',
      sortComercio: 'default',
      comerciosConDistancia: []
    };

    // --- OPTIMIZACI√ìN DE C√ÅLCULO DE DISTANCIA ---

    // 1. Haversine: Calcula distancia lineal (Offline y ultra r√°pido)
    function getLinealDist(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    // 2. OSRM con Cach√©: Calcula por carretera solo si es necesario
    async function getRoadDist(comercioGPS, userGPS) {
      try {
        const cacheKey = `route_${comercioGPS}_${userGPS}`;
        const cached = localStorage.getItem(cacheKey);
        
        // Cach√© de 20 min para evitar llamadas repetitivas
        if (cached) {
          const { data, time } = JSON.parse(cached);
          if (Date.now() - time < 1200000) return data;
        }

        const [cLat, cLon] = comercioGPS.split(',').map(Number);
        const [uLat, uLon] = userGPS.split(',').map(Number);

        // Si la distancia lineal es > 40km, ni siquiera preguntamos a la API (filtro de seguridad)
        if (getLinealDist(cLat, cLon, uLat, uLon) > 40) return { exito: false };

        const url = `https://router.project-osrm.org/route/v1/driving/${cLon},${cLat};${uLon},${uLat}?overview=false`;
        const res = await fetch(url);
        const json = await res.json();

        if (json.code === 'Ok' && json.routes?.length > 0) {
          const result = {
            km: (json.routes[0].distance / 1000).toFixed(1),
            min: Math.round(json.routes[0].duration / 60) + 10, // +10 min de preparaci√≥n
            exito: true
          };
          localStorage.setItem(cacheKey, JSON.stringify({ data: result, time: Date.now() }));
          return result;
        }
        return { exito: false };
      } catch (e) { return { exito: false }; }
    }

    // 3. Procesador en lotes para no saturar la UI
    async function processDistances() {
      const filtered = appData.comercios.filter(c => c.CATEGORIA == appData.selectedCategoria);
      
      // Mostrar primero los comercios sin distancia para carga instant√°nea
      appData.comerciosConDistancia = filtered.map(c => ({...c, distData: null}));
      renderComercios();

      if (!appData.userLocation) return;

      // Calcular en paralelo
      const promises = filtered.map(async (com) => {
        const gps = com['GPS COMERCIO'] || com.GPS;
        if (gps) {
          const res = await getRoadDist(gps, appData.userLocation);
          return { ...com, distData: res.exito ? res : null };
        }
        return { ...com, distData: null };
      });

      const results = await Promise.all(promises);
      appData.comerciosConDistancia = results;
      
      // Si el orden es por distancia, re-renderizar
      if (appData.sortComercio === 'distance') {
        appData.comerciosConDistancia.sort((a, b) => {
          if (!a.distData) return 1;
          if (!b.distData) return -1;
          return parseFloat(a.distData.km) - parseFloat(b.distData.km);
        });
      }
      renderComercios();
    }

    // --- L√ìGICA DE NAVEGACI√ìN Y RENDER ---

    function getImg(url, alt) {
      if (!url || url.length < 10) return `https://ui-avatars.com/api/?name=${alt}&background=FF8C00&color=fff`;
      if (url.includes('drive.google.com')) {
        const id = url.split('id=')[1] || url.split('/d/')[1]?.split('/')[0];
        return `https://drive.google.com/uc?export=view&id=${id}`;
      }
      return url;
    }

    window.addEventListener('DOMContentLoaded', async () => {
      initLocation();
      try {
        const res = await fetch(SCRIPT_URL + '?action=getData');
        const data = await res.json();
        if (data.success) {
          appData.comercios = data.comercios;
          appData.categorias = data.categorias;
          appData.productos = data.productos;
          
          document.getElementById('loading').classList.add('hidden');
          document.getElementById('categoriasSection').classList.remove('hidden');
          
          renderBanners();
          renderCategorias();
          setupEvents();
        }
      } catch (e) { alert("Error de conexi√≥n. Reintenta."); }
    });

    function initLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          appData.userLocation = `${pos.coords.latitude},${pos.coords.longitude}`;
          document.getElementById('locationText').textContent = "Ubicaci√≥n fijada";
        });
      }
    }

    function renderBanners() {
      const banners = [
        { t: 'ENV√çO GRATIS', s: 'En pedidos seleccionados', c: 'from-orange-500 to-red-500' },
        { t: 'M√ÅS R√ÅPIDO', s: 'Llegamos en tiempo r√©cord', c: 'from-blue-600 to-indigo-700' }
      ];
      const container = document.getElementById('bannerCarousel');
      container.innerHTML = banners.map(b => `
        <div class="carousel-item bg-gradient-to-br ${b.c} rounded-3xl p-8 text-white w-[85%] min-w-[280px]">
          <h3 class="text-2xl font-black mb-1">${b.t}</h3>
          <p class="text-xs font-bold opacity-80 uppercase tracking-widest">${b.s}</p>
        </div>
      `).join('');
    }

    function renderCategorias() {
      const list = document.getElementById('categoriasList');
      list.innerHTML = appData.categorias.map(cat => `
        <div class="cat-card cursor-pointer group" data-id="${cat['üîí Row ID'] || cat.ROWID}" data-name="${cat.CATEGORIA}">
          <div class="bg-white rounded-2xl p-4 flex flex-col items-center shadow-sm group-hover:shadow-md transition group-active:scale-95">
            <img src="${getImg(cat.IMAGEN, cat.CATEGORIA)}" class="w-12 h-12 object-contain mb-2">
            <span class="text-[10px] font-black uppercase text-center text-gray-800">${cat.CATEGORIA}</span>
          </div>
        </div>
      `).join('');

      document.querySelectorAll('.cat-card').forEach(card => {
        card.onclick = () => {
          appData.selectedCategoria = card.dataset.id;
          document.getElementById('categoriaTitulo').textContent = card.dataset.name;
          document.getElementById('categoriasSection').classList.add('hidden');
          document.getElementById('comerciosSection').classList.remove('hidden');
          processDistances();
        };
      });
    }

    function renderComercios() {
      const list = document.getElementById('comerciosList');
      document.getElementById('comerciosLoader').classList.add('hidden');
      
      let filtered = [...appData.comerciosConDistancia];
      if (appData.searchTermComercio) {
        filtered = filtered.filter(c => c.COMERCIO.toLowerCase().includes(appData.searchTermComercio.toLowerCase()));
      }

      list.innerHTML = filtered.map(c => {
        const isOpen = c['ABIERTO?'] === 'SI' || c['ABIERTO?'] === true;
        return `
          <div class="com-card bg-white rounded-[2rem] overflow-hidden shadow-sm hover:shadow-xl transition cursor-pointer relative ${!isOpen ? 'grayscale opacity-70' : ''}" data-id="${c.ID}">
            <div class="h-40 relative">
              <img src="${getImg(c.IMAGEN, c.COMERCIO)}" class="w-full h-full object-cover">
              ${c.distData ? `
                <div class="absolute top-4 left-4 distance-badge text-white px-3 py-1.5 rounded-xl text-[10px] font-black">
                  üìç ${c.distData.km} KM
                </div>
              ` : ''}
              ${!isOpen ? '<div class="absolute inset-0 bg-black/40 flex items-center justify-center text-white font-black uppercase">Cerrado</div>' : ''}
            </div>
            <div class="p-6">
              <h3 class="text-lg font-black mb-1">${c.COMERCIO}</h3>
              <p class="text-xs text-gray-400 font-bold uppercase mb-3">${c.SECTOR || 'Honduras'}</p>
              <div class="flex items-center gap-4">
                <span class="text-[10px] font-black px-2 py-1 bg-green-100 text-green-600 rounded-md uppercase">Env√≠o L.40</span>
                ${c.distData ? `<span class="text-[10px] font-black px-2 py-1 bg-blue-100 text-blue-600 rounded-md uppercase">üïí ${c.distData.min} MIN</span>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');

      document.querySelectorAll('.com-card').forEach(card => {
        card.onclick = () => openComercio(card.dataset.id);
      });
    }

    function openComercio(id) {
      appData.currentComercio = appData.comercios.find(c => c.ID == id);
      document.getElementById('comerciosSection').classList.add('hidden');
      document.getElementById('productosSection').classList.remove('hidden');
      
      document.getElementById('comercioHeader').innerHTML = `
        <h2 class="text-2xl font-black">${appData.currentComercio.COMERCIO}</h2>
        <p class="text-xs text-gray-400 font-bold uppercase">${appData.currentComercio.DIRECCION || ''}</p>
      `;
      renderProductos();
    }

    function renderProductos() {
      const list = document.getElementById('productosList');
      const filtered = appData.productos.filter(p => p.COMERCIO == appData.currentComercio.ID);
      
      list.innerHTML = filtered.map(p => `
        <div class="bg-white p-4 rounded-3xl shadow-sm flex items-center gap-4">
          <img src="${getImg(p.IMAGEN, p.NOMBRE)}" class="w-20 h-20 rounded-2xl object-cover">
          <div class="flex-1">
            <h4 class="font-black text-sm uppercase">${p.NOMBRE}</h4>
            <p class="text-[10px] text-gray-400 mb-2 line-clamp-1">${p.DESCRIPCION || ''}</p>
            <div class="flex justify-between items-center">
              <span class="font-black brand-orange">L.${p.PRECIO}</span>
              <button class="add-btn bg-brand-orange text-white p-2 rounded-xl shadow-lg shadow-orange-100 active:scale-90 transition" data-p='${JSON.stringify(p)}'>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path></svg>
              </button>
            </div>
          </div>
        </div>
      `).join('');

      document.querySelectorAll('.add-btn').forEach(btn => {
        btn.onclick = () => {
          const prod = JSON.parse(btn.dataset.p);
          const exist = appData.cart.find(item => item.ID == prod.ID);
          if (exist) exist.qty++;
          else appData.cart.push({...prod, qty: 1});
          updateCartUI();
        };
      });
    }

    function updateCartUI() {
      const count = appData.cart.reduce((s, i) => s + i.qty, 0);
      document.getElementById('cartCount').textContent = count;
      const total = appData.cart.reduce((s, i) => s + (i.PRECIO * i.qty), 0);
      document.getElementById('cartTotal').textContent = total.toFixed(2);
    }

    function renderCart() {
      const container = document.getElementById('cartItems');
      if (appData.cart.length === 0) {
        container.innerHTML = '<div class="text-center py-10 text-gray-400 font-bold uppercase text-xs">Tu carrito est√° vac√≠o</div>';
        return;
      }
      container.innerHTML = appData.cart.map((item, idx) => `
        <div class="flex justify-between items-center mb-4 bg-gray-50 p-4 rounded-2xl">
          <div>
            <p class="font-black text-xs uppercase">${item.NOMBRE}</p>
            <p class="text-xs brand-orange font-bold">L.${item.PRECIO}</p>
          </div>
          <div class="flex items-center gap-3">
            <button class="w-8 h-8 bg-white rounded-lg shadow-sm font-black" onclick="changeQty(${idx}, -1)">-</button>
            <span class="font-black text-sm">${item.qty}</span>
            <button class="w-8 h-8 bg-brand-orange text-white rounded-lg shadow-sm font-black" onclick="changeQty(${idx}, 1)">+</button>
          </div>
        </div>
      `).join('');
    }

    window.changeQty = (idx, delta) => {
      appData.cart[idx].qty += delta;
      if (appData.cart[idx].qty <= 0) appData.cart.splice(idx, 1);
      updateCartUI();
      renderCart();
    };

    function setupEvents() {
      document.getElementById('backToCategorias').onclick = () => {
        document.getElementById('comerciosSection').classList.add('hidden');
        document.getElementById('categoriasSection').classList.remove('hidden');
      };
      
      document.getElementById('backBtn').onclick = () => {
        document.getElementById('productosSection').classList.add('hidden');
        document.getElementById('comerciosSection').classList.remove('hidden');
      };

      document.getElementById('cartBtn').onclick = () => {
        renderCart();
        document.getElementById('cartModal').classList.remove('hidden');
      };

      document.getElementById('closeCartBtn').onclick = () => document.getElementById('cartModal').classList.add('hidden');

      document.getElementById('searchComercio').oninput = (e) => {
        appData.searchTermComercio = e.target.value;
        renderComercios();
      };

      document.getElementById('sortComercio').onchange = (e) => {
        appData.sortComercio = e.target.value;
        processDistances();
      };

      document.getElementById('checkoutBtn').onclick = () => {
        if (appData.cart.length > 0) {
          document.getElementById('cartModal').classList.add('hidden');
          document.getElementById('checkoutModal').classList.remove('hidden');
        }
      };

      document.getElementById('cancelCheckoutBtn').onclick = () => document.getElementById('checkoutModal').classList.add('hidden');

      document.getElementById('checkoutForm').onsubmit = (e) => {
        e.preventDefault();
        sendOrder();
      };

      document.getElementById('customProductBtn').onclick = () => document.getElementById('customProductModal').classList.remove('hidden');
      document.getElementById('cancelCustomBtn').onclick = () => document.getElementById('customProductModal').classList.add('hidden');
      document.getElementById('customProductForm').onsubmit = (e) => {
        e.preventDefault();
        const p = {
          ID: 'custom_' + Date.now(),
          NOMBRE: document.getElementById('customName').value,
          PRECIO: document.getElementById('customPrice').value,
          qty: 1
        };
        appData.cart.push(p);
        updateCartUI();
        document.getElementById('customProductModal').classList.add('hidden');
        document.getElementById('customProductForm').reset();
      };
    }

    async function sendOrder() {
      const cel = document.getElementById('celular').value;
      const dir = document.getElementById('direccion').value;
      const total = appData.cart.reduce((s, i) => s + (i.PRECIO * i.qty), 0);
      
      const itemsText = appData.cart.map(i => `${i.qty}x ${i.NOMBRE} (L.${i.PRECIO})`).join('\n');
      const mensaje = `üõµ *NUEVO PEDIDO SOMAR EXPRESS*\n\n` +
                      `*Comercio:* ${appData.currentComercio.COMERCIO}\n` +
                      `*Productos:*\n${itemsText}\n\n` +
                      `*Total: L.${total.toFixed(2)}*\n\n` +
                      `*Cliente:* ${cel}\n` +
                      `*Direcci√≥n:* ${dir}\n` +
                      `*GPS:* ${appData.userLocation || 'No disponible'}`;

      confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

      setTimeout(() => {
        let wa = (appData.currentComercio.WHATSAPP || '50499999999').toString().replace(/\D/g, '');
        if (wa.length === 8) wa = '504' + wa;
        window.open(`https://wa.me/${wa}?text=${encodeURIComponent(mensaje)}`, '_blank');
        location.reload();
      }, 2000);
    }
  </script>
</body>
</html>
