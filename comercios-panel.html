<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#FF8C00">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Somar Comercios">
  
  <!-- Manifest -->
  <link rel="manifest" href="./manifest.json">
  
  <!-- Icons -->
  <link rel="icon" type="image/png" href="https://res.cloudinary.com/drkaxsziu/image/upload/v1767871213/Somar_Express_2048_x_2048_px_18_x_18_in__20250623_221102_0000_o0bv7a.png">
  <link rel="apple-touch-icon" href="https://res.cloudinary.com/drkaxsziu/image/upload/v1767871213/Somar_Express_2048_x_2048_px_18_x_18_in__20250623_221102_0000_o0bv7a.png">
  
  <title>Somar Express - Panel Comercios</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    #updateNotification {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .brand-orange { color: #FF8C00; }
    .bg-brand-orange { background-color: #FF8C00; }
    
    .loading {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #FFFFFF;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-small {
      border: 2px solid rgba(255, 140, 0, 0.3);
      border-top: 2px solid #FF8C00;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    
    .fade-in { animation: fadeIn 0.4s ease-in; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .scale-in { animation: scaleIn 0.2s ease-out; }
    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    #mapPreviewRecogida, #mapPreviewEntrega, #mapInteractive {
      height: 250px;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      z-index: 1;
    }

    #contentNuevoEnvio {
      position: relative;
      z-index: 10;
    }

    .bg-white.border-b.sticky {
      z-index: 40 !important;
    }

    header {
      z-index: 50 !important;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-PENDIENTE { background: #FEF3C7; color: #92400E; }
.status-PENDIENTE_ASIGNACION { background: #FED7AA; color: #9A3412; }
.status-ACEPTADO { background: #DBEAFE; color: #1E40AF; }
    .status-EN_ESTABLECIMIENTO { background: #E0E7FF; color: #3730A3; }
    .status-PEDIDO_EN_CAMINO { background: #DDD6FE; color: #5B21B6; }
    .status-ENTREGANDO { background: #FCE7F3; color: #9F1239; }
    .status-FINALIZADO { background: #D1FAE5; color: #065F46; }
    .status-CANCELADO { background: #FEE2E2; color: #991B1B; }
  </style>

  <script src="./config-seguro-comercios.js"></script>
</head>
<body class="bg-gray-50">
  
  <!-- Header -->
  <header class="bg-white sticky top-0 z-50 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="https://res.cloudinary.com/drkaxsziu/image/upload/v1767871213/Somar_Express_2048_x_2048_px_18_x_18_in__20250623_221102_0000_o0bv7a.png" alt="Somar Express" class="w-12 h-12 object-contain">
          <div>
            <h1 class="font-bold text-lg">Panel Comercios</h1>
            <p class="text-xs text-gray-500" id="comercioName">Cargando...</p>
          </div>
        </div>
        
        <button id="logoutBtn" class="p-2 hover:bg-gray-100 rounded-full transition" title="Cerrar SesiÃ³n">
          <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Modal de AutenticaciÃ³n -->
  <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-md w-full scale-in">
      <div class="p-6">
        <!-- Paso 1: Ingresar TelÃ©fono -->
        <div id="authStep1">
          <div class="text-center mb-6">
            <img src="https://res.cloudinary.com/drkaxsziu/image/upload/v1767871213/Somar_Express_2048_x_2048_px_18_x_18_in__20250623_221102_0000_o0bv7a.png" alt="Somar Express" class="w-24 h-24 mx-auto mb-4">
            <h2 class="text-2xl font-bold mb-2">Panel de Comercios</h2>
            <p class="text-gray-600">Ingresa tu nÃºmero para gestionar tus envÃ­os</p>
          </div>
          <form id="authPhoneForm">
            <div class="mb-4">
              <label class="block font-semibold mb-2 text-sm text-gray-700">NÃºmero de Celular</label>
              <input type="tel" id="authPhone" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition" placeholder="+504 9999-9999">
              <p class="text-xs text-gray-500 mt-1">RecibirÃ¡s un cÃ³digo por WhatsApp</p>
            </div>
            <button type="submit" class="w-full bg-brand-orange text-white py-4 rounded-xl font-bold hover:bg-orange-600 transition shadow-lg">Continuar</button>
          </form>
        </div>

        <!-- Paso 2: Verificar CÃ³digo -->
        <div id="authStep2" class="hidden">
          <div class="text-center mb-6">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h2 class="text-2xl font-bold mb-2">CÃ³digo Enviado</h2>
            <p class="text-gray-600">Revisa tu WhatsApp e ingresa el cÃ³digo</p>
            <p class="text-sm text-gray-500 mt-2">Enviado a <span id="phoneDisplay" class="font-semibold"></span></p>
          </div>
          <form id="authCodeForm">
            <div class="mb-4">
              <input type="text" id="authCode" required maxlength="6" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-center text-2xl font-bold tracking-widest focus:border-brand-orange focus:outline-none transition" placeholder="000000">
            </div>
            <button type="submit" class="w-full bg-brand-orange text-white py-4 rounded-xl font-bold hover:bg-orange-600 transition shadow-lg mb-3">Verificar</button>
            <button type="button" id="resendCodeBtn" class="w-full text-brand-orange font-semibold hover:underline">Reenviar cÃ³digo</button>
          </form>
        </div>

        <!-- Paso 3: Registro -->
        <div id="authStep3" class="hidden">
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold mb-2">Completa tu Registro</h2>
            <p class="text-gray-600">Necesitamos algunos datos de tu comercio</p>
          </div>
          <form id="authRegisterForm">
            <div class="mb-4">
              <label class="block font-semibold mb-2 text-sm text-gray-700">Nombre del Comercio *</label>
              <input type="text" id="authNombreComercio" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition" placeholder="Ej: Restaurante El Buen Sabor">
            </div>
            <div class="mb-4">
              <label class="block font-semibold mb-2 text-sm text-gray-700">DirecciÃ³n del Comercio *</label>
              <textarea id="authDireccionComercio" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition" rows="2" placeholder="Colonia, calle, referencias..."></textarea>
            </div>
            <div class="mb-4">
              <label class="block font-semibold mb-2 text-sm text-gray-700">UbicaciÃ³n GPS del Comercio</label>
              <div class="flex gap-2">
                <input type="text" id="authUbicacionGPS" class="flex-1 border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition" placeholder="Lat, Lon" readonly>
                <button type="button" id="getLocationBtn" class="bg-blue-500 text-white px-4 rounded-xl font-semibold hover:bg-blue-600 transition">
                  ðŸ“ Obtener
                </button>
              </div>
            </div>
            <button type="submit" class="w-full bg-brand-orange text-white py-4 rounded-xl font-bold hover:bg-orange-600 transition shadow-lg">Registrar Comercio</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Vista Principal -->
  <div id="mainContent" class="hidden">
    <!-- Tabs -->
<div class="bg-white border-b sticky top-16 z-40">
  <div class="max-w-7xl mx-auto px-4">
    <div class="flex gap-4">
      <button id="tabNuevoEnvio" class="tab-btn py-4 px-6 font-semibold border-b-2 border-brand-orange brand-orange">
        Nuevo EnvÃ­o
      <button id="tabMisSolicitudes" class="tab-btn py-4 px-6 font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-800">
  ðŸ“‹ Mis Solicitudes
      </button>
      
      <!-- ðŸ‘‡ AGREGAR ESTE BOTÃ“N -->
      <button id="tabSolicitarEntrega" class="tab-btn py-4 px-6 font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-800">
        ðŸšš Solicitar Entrega
      </button>
      
    </div>
  </div>
</div>

    <!-- Contenido Tab: Nuevo EnvÃ­o -->
    <div id="contentNuevoEnvio" class="max-w-3xl mx-auto p-4">
      <form id="nuevoEnvioForm" class="bg-white rounded-2xl shadow-sm p-6 space-y-6">
        <h2 class="text-2xl font-bold mb-4">Crear Nuevo EnvÃ­o</h2>

        <!-- Tipo de Servicio -->
        <div>
          <label class="block font-semibold mb-3 text-gray-700">ðŸ“¦ Tipo de Servicio *</label>
          <div class="grid grid-cols-2 gap-3">
            <label class="relative cursor-pointer">
              <input type="radio" name="tipoServicio" value="SOLO_ENTREGA" class="peer sr-only" checked>
              <div class="border-2 border-gray-200 rounded-xl p-4 text-center peer-checked:border-brand-orange peer-checked:bg-orange-50 transition">
                <div class="text-3xl mb-2">ðŸ“¦</div>
                <div class="font-semibold">Solo Entrega</div>
                <div class="text-xs text-gray-500 mt-1">EnvÃ­o simple</div>
              </div>
            </label>
            <label class="relative cursor-pointer">
              <input type="radio" name="tipoServicio" value="PAGO_CONTRA_ENTREGA" class="peer sr-only">
              <div class="border-2 border-gray-200 rounded-xl p-4 text-center peer-checked:border-brand-orange peer-checked:bg-orange-50 transition">
                <div class="text-3xl mb-2">ðŸ’°</div>
                <div class="font-semibold">Contra Entrega</div>
                <div class="text-xs text-gray-500 mt-1">Cobrar al entregar</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Quien Paga -->
        <div>
          <label class="block font-semibold mb-3 text-gray-700">ðŸ’³ Â¿QuiÃ©n paga el envÃ­o? *</label>
          <div class="grid grid-cols-2 gap-3">
            <label class="relative cursor-pointer">
              <input type="radio" name="quienPaga" value="DESTINATARIO" class="peer sr-only" checked>
              <div class="border-2 border-gray-200 rounded-xl p-4 text-center peer-checked:border-brand-orange peer-checked:bg-orange-50 transition">
                <div class="text-2xl mb-1">ðŸ‘¤</div>
                <div class="font-semibold">Destinatario</div>
              </div>
            </label>
            <label class="relative cursor-pointer">
              <input type="radio" name="quienPaga" value="COMERCIO" class="peer sr-only">
              <div class="border-2 border-gray-200 rounded-xl p-4 text-center peer-checked:border-brand-orange peer-checked:bg-orange-50 transition">
                <div class="text-2xl mb-1">ðŸª</div>
                <div class="font-semibold">Yo (Comercio)</div>
              </div>
            </label>
          </div>
        </div>

        <!-- UbicaciÃ³n de Recogida -->
        <div>
          <label class="block font-semibold mb-3 text-gray-700">ðŸ“ UbicaciÃ³n de Recogida *</label>
          <div class="flex gap-2 mb-2">
            <button type="button" id="usarUbicacionGuardada" class="flex-1 bg-blue-500 text-white py-3 rounded-xl font-semibold hover:bg-blue-600 transition">
              âœ“ Usar mi ubicaciÃ³n guardada
            </button>
            <button type="button" id="cambiarRecogida" class="flex-1 border-2 border-gray-300 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-50 transition">
              ðŸ”„ Cambiar
            </button>
          </div>
          <div id="recogidaCustom" class="hidden">
            <input type="text" id="linkRecogida" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition mb-2" placeholder="Pega link de Google Maps">
            <div id="mapPreviewRecogida" class="hidden mb-2"></div>
          </div>
          <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded-xl">
            <span class="font-semibold">ðŸ“Œ Actual:</span> <span id="direccionRecogidaDisplay">Cargando...</span>
          </div>
        </div>

        <!-- UbicaciÃ³n de Entrega -->
        <div>
          <label class="block font-semibold mb-3 text-gray-700 flex items-center justify-between">
            <span>ðŸ“ UbicaciÃ³n de Entrega *</span>
            <button type="button" id="abrirAyudaWhatsapp" class="text-xs text-blue-600 hover:text-blue-800 font-normal">
              Â¿CÃ³mo obtenerla? ðŸ’¡
            </button>
          </label>
          
          <div class="bg-blue-50 border-l-4 border-blue-400 p-3 mb-3 text-sm">
            <p class="font-semibold text-blue-800 mb-1">ðŸ“± Â¿Tu cliente te mandÃ³ la ubicaciÃ³n por WhatsApp?</p>
            <p class="text-blue-700">Reenviala al Whatsapp +504 8912-5089 para que te genere las coordenadas facilmente.</p>
          </div>
          
          <div class="relative">
            <textarea id="linkEntrega" rows="2" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 pr-10 focus:border-brand-orange focus:outline-none transition resize-none" placeholder="Pega aquÃ­: Las coordenadas (14.0818, -87.2068)
"></textarea>
            <div id="linkEntregaStatus" class="hidden absolute right-3 top-3">
              <div class="loading-small"></div>
            </div>
          </div>
          
          <div id="ubicacionDetectada" class="hidden bg-green-50 border-2 border-green-300 rounded-xl p-3 mt-2 mb-2">
            <div class="flex items-start gap-2">
              <span class="text-xl">âœ…</span>
              <div class="flex-1">
                <p class="font-semibold text-green-800 text-sm">UbicaciÃ³n detectada correctamente</p>
                <p class="text-xs text-green-700 mt-1" id="coordenadasDetectadas"></p>
              </div>
            </div>
          </div>
          
          <div id="ubicacionError" class="hidden bg-red-50 border-2 border-red-300 rounded-xl p-3 mt-2 mb-2">
            <div class="flex items-start gap-2">
              <span class="text-xl">âš ï¸</span>
              <div class="flex-1">
                <p class="font-semibold text-red-800 text-sm">No se detectÃ³ ubicaciÃ³n</p>
                <p class="text-xs text-red-700 mt-1">Verifica que hayas pegado el link completo o usa el mapa interactivo</p>
              </div>
            </div>
          </div>
          
          <div id="mapPreviewEntrega" class="hidden mb-2"></div>
          
          <div class="text-center my-3">
            <p class="text-xs text-gray-500 mb-2">- O -</p>
          </div>
          
          <button type="button" id="usarMapaInteractivo" class="w-full border-2 border-dashed border-gray-300 text-gray-600 py-3 rounded-xl font-semibold hover:border-brand-orange hover:text-brand-orange transition">
            ðŸ—ºï¸ Usar mapa interactivo
          </button>
        </div>

        <!-- Datos del Destinatario -->
        <div class="border-t pt-6">
          <h3 class="font-bold text-lg mb-4">ðŸ‘¤ Datos del Destinatario</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block font-semibold mb-2 text-sm text-gray-700">Nombre *</label>
              <input type="text" id="nombreDestinatario" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition" placeholder="Nombre completo">
            </div>
            <div>
              <label class="block font-semibold mb-2 text-sm text-gray-700">TelÃ©fono *</label>
              <input type="tel" id="telefonoDestinatario" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition" placeholder="+504 9999-9999">
            </div>
          </div>
        </div>

        <!-- DescripciÃ³n del Paquete -->
        <div>
          <label class="block font-semibold mb-2 text-sm text-gray-700">ðŸ“¦ DescripciÃ³n del Paquete *</label>
          <textarea id="descripcionPaquete" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition" rows="3" placeholder="Ej: 2 cajas de pizza, 1 refresco de 2 litros"></textarea>
        </div>

        <!-- Foto del Paquete -->
        <div>
          <label class="block font-semibold mb-2 text-sm text-gray-700">ðŸ“¸ Foto del Paquete (Opcional)</label>
          <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-brand-orange transition cursor-pointer" id="uploadArea">
            <input type="file" id="fotoPaquete" accept="image/*" class="hidden">
            <div id="uploadPlaceholder">
              <div class="text-5xl mb-2">ðŸ“¸</div>
              <p class="text-sm text-gray-600 font-semibold">Click para subir foto</p>
              <p class="text-xs text-gray-500 mt-1">JPG, PNG (mÃ¡x. 5MB)</p>
            </div>
            <div id="uploadPreview" class="hidden">
              <img id="previewImg" class="mx-auto max-h-40 rounded-lg mb-2">
              <p class="text-sm text-green-600 font-semibold">âœ“ Foto cargada</p>
              <button type="button" id="removeFoto" class="text-xs text-red-500 hover:text-red-700 mt-2">Cambiar imagen</button>
            </div>
          </div>
        </div>

        <!-- Monto a Cobrar -->
        <div id="montoSection" class="hidden">
          <label class="block font-semibold mb-2 text-sm text-gray-700">ðŸ’µ Monto a Cobrar (Contra Entrega) *</label>
          <div class="relative">
            <span class="absolute left-4 top-1/2 transform -translate-y-1/2 font-bold text-gray-500">L.</span>
            <input type="number" id="montoCobrar" class="w-full border-2 border-gray-200 rounded-xl pl-10 pr-4 py-3 focus:border-brand-orange focus:outline-none transition" placeholder="0.00" step="0.01" min="0">
          </div>
        </div>

        <!-- Tipo de Pago del EnvÃ­o -->
        <div>
          <label class="block font-semibold mb-3 text-gray-700">ðŸ’³ MÃ©todo de Pago del EnvÃ­o *</label>
          <div class="grid grid-cols-2 gap-3">
            <label class="relative cursor-pointer">
              <input type="radio" name="tipoPagoEnvio" value="EFECTIVO" class="peer sr-only" checked>
              <div class="border-2 border-gray-200 rounded-xl p-4 text-center peer-checked:border-brand-orange peer-checked:bg-orange-50 transition">
                <div class="text-2xl mb-1">ðŸ’µ</div>
                <div class="font-semibold">Efectivo</div>
              </div>
            </label>
            <label class="relative cursor-pointer">
              <input type="radio" name="tipoPagoEnvio" value="TRANSFERENCIA" class="peer sr-only">
              <div class="border-2 border-gray-200 rounded-xl p-4 text-center peer-checked:border-brand-orange peer-checked:bg-orange-50 transition">
                <div class="text-2xl mb-1">ðŸ¦</div>
                <div class="font-semibold">Transferencia</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Notas Adicionales -->
        <div>
          <label class="block font-semibold mb-2 text-sm text-gray-700">ðŸ“ Notas Adicionales (Opcional)</label>
          <textarea id="notasAdicionales" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition" rows="2" placeholder="Ej: Tocar el timbre, dejar en porterÃ­a, etc."></textarea>
        </div>

        <!-- Resumen de Tarifa -->
        <div id="tarifaResumen" class="hidden bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
          <h3 class="font-bold mb-3">ðŸ’° Estimado de Tarifa</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-700">Origen:</span>
              <span class="font-semibold" id="ciudadOrigen">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-700">Destino:</span>
              <span class="font-semibold" id="ciudadDestino">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-700">Distancia:</span>
              <span class="font-semibold" id="distanciaKm">-</span>
            </div>
            <div class="flex justify-between border-t pt-2 mt-2">
              <span class="text-gray-700">Tarifa Estimada:</span>
              <span class="font-bold text-lg brand-orange">L.<span id="tarifaTotal">0.00</span></span>
            </div>
          </div>
        </div>

        <button type="submit" class="w-full bg-brand-orange text-white py-4 rounded-xl font-bold text-lg hover:bg-orange-600 transition shadow-lg">
          ðŸš€ Crear EnvÃ­o
        </button>
      </form>
    </div>

    <!-- Contenido Tab: Mis Solicitudes (EnvÃ­os + Entregas) -->
    <div id="contentMisSolicitudes" class="hidden max-w-5xl mx-auto p-4">
    <div class="mb-4 flex flex-wrap gap-2">
  <!-- Filtro por Tipo -->
  <select id="filtroTipo" class="border-2 border-gray-200 rounded-xl px-4 py-2 focus:border-brand-orange focus:outline-none transition">
    <option value="">Todos los tipos</option>
    <option value="ENVIO">ðŸ“¦ EnvÃ­os</option>
    <option value="ENTREGA">ðŸšš Entregas/Solicitudes</option>
  </select>
  
  <!-- Filtro por Estado -->
  <select id="filtroEstado" class="border-2 border-gray-200 rounded-xl px-4 py-2 focus:border-brand-orange focus:outline-none transition">
    <option value="">Todos los estados</option>
    <option value="PENDIENTE">Pendiente</option>
    <option value="PENDIENTE_ASIGNACION">Pendiente AsignaciÃ³n</option>
    <option value="ACEPTADO">Aceptado</option>
    <option value="EN_ESTABLECIMIENTO">En Establecimiento</option>
    <option value="PEDIDO_EN_CAMINO">Pedido en Camino</option>
    <option value="ENTREGANDO">Entregando</option>
    <option value="FINALIZADO">Finalizado</option>
    <option value="CANCELADO">Cancelado</option>
  </select>
  
  <button id="refrescarSolicitudes" class="bg-blue-500 text-white px-4 py-2 rounded-xl font-semibold hover:bg-blue-600 transition">
    ðŸ”„ Refrescar
  </button>
</div>
<div id="listaSolicitudes" class="space-y-4">
        <div class="text-center py-12 text-gray-500">
          <p class="text-lg font-semibold">Cargando envÃ­os...</p>
        </div>
      </div>

      <!-- Contenido Tab: Solicitar Entrega -->
<div id="containerSolicitarEntrega" class="hidden">
  <div id="contentSolicitarEntrega" class="max-w-4xl mx-auto p-4">
    <!-- Selector de Tipo de Servicio -->
    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
      <h2 class="text-2xl font-bold mb-4">Solicitar Entrega</h2>
      <p class="text-gray-600 mb-6">Selecciona el tipo de servicio que necesitas:</p>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Traslado entre Tiendas -->
        <label class="relative cursor-pointer">
          <input type="radio" name="tipoServicioEntrega" value="TRASLADO_TIENDAS" class="peer sr-only" checked>
          <div class="border-2 border-gray-200 rounded-xl p-6 text-center peer-checked:border-brand-orange peer-checked:bg-orange-50 transition hover:shadow-md">
            <div class="text-5xl mb-3">ðŸª</div>
            <h3 class="font-bold text-lg mb-2">Traslado</h3>
            <p class="text-sm text-gray-600">Entre mis tiendas</p>
          </div>
        </label>

        <!-- Recoger Paquete -->
        <label class="relative cursor-pointer">
          <input type="radio" name="tipoServicioEntrega" value="RECOGER_PAQUETE" class="peer sr-only">
          <div class="border-2 border-gray-200 rounded-xl p-6 text-center peer-checked:border-brand-orange peer-checked:bg-orange-50 transition hover:shadow-md">
            <div class="text-5xl mb-3">ðŸ“¦</div>
            <h3 class="font-bold text-lg mb-2">Recoger</h3>
            <p class="text-sm text-gray-600">Un paquete</p>
          </div>
        </label>

        <!-- Realizar Compra -->
        <label class="relative cursor-pointer">
          <input type="radio" name="tipoServicioEntrega" value="REALIZAR_COMPRA" class="peer sr-only">
          <div class="border-2 border-gray-200 rounded-xl p-6 text-center peer-checked:border-brand-orange peer-checked:bg-orange-50 transition hover:shadow-md">
            <div class="text-5xl mb-3">ðŸ›’</div>
            <h3 class="font-bold text-lg mb-2">Compra</h3>
            <p class="text-sm text-gray-600">Por encargo</p>
          </div>
        </label>
      </div>
    </div>

    <!-- Formulario de Solicitud -->
    <form id="formSolicitarEntrega" class="bg-white rounded-2xl shadow-sm p-6">
      
      <!-- SECCIÃ“N: TRASLADO ENTRE TIENDAS -->
      <div id="seccionTrasladoTiendas" class="form-section">
        <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
          <span>ðŸª</span> Traslado entre Tiendas
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <!-- Tienda Origen -->
          <div>
            <label class="block font-semibold mb-2 text-sm text-gray-700">Tienda Origen *</label>
            <select id="tiendaOrigen" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition">
              <option value="">Selecciona tienda</option>
              <option value="tienda1" data-gps="15.6100,-87.9533">Tienda Principal - Choloma</option>
              <option value="tienda2" data-gps="15.5000,-88.0300">Sucursal SPS - San Pedro Sula</option>
              <option value="tienda3" data-gps="14.0800,-87.2100">Bodega Central - Tegucigalpa</option>
            </select>
          </div>

          <!-- Tienda Destino -->
          <div>
            <label class="block font-semibold mb-2 text-sm text-gray-700">Tienda Destino *</label>
            <select id="tiendaDestino" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition">
              <option value="">Selecciona tienda</option>
              <option value="tienda1" data-gps="15.6100,-87.9533">Tienda Principal - Choloma</option>
              <option value="tienda2" data-gps="15.5000,-88.0300">Sucursal SPS - San Pedro Sula</option>
              <option value="tienda3" data-gps="14.0800,-87.2100">Bodega Central - Tegucigalpa</option>
            </select>
          </div>
        </div>
      </div>

      <!-- SECCIÃ“N: RECOGER PAQUETE -->
      <div id="seccionRecogerPaquete" class="form-section hidden">
        <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
          <span>ðŸ“¦</span> Recoger Paquete
        </h3>

        <div class="mb-4">
          <label class="block font-semibold mb-2 text-sm text-gray-700">UbicaciÃ³n de Recogida *</label>
          <div class="flex gap-2 mb-2">
            <input type="text" id="ubicacionRecogidaPaquete" placeholder="Pega las coordenadas: 15.6100,-87.9533" required class="flex-1 border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition">
          </div>
          <p class="text-xs text-gray-500">TambiÃ©n puedes usar el mapa interactivo</p>
        </div>

        <div class="mb-4">
          <label class="block font-semibold mb-2 text-sm text-gray-700">Nombre del Contacto *</label>
          <input type="text" id="nombreContactoRecogida" placeholder="Persona que entrega el paquete" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition">
        </div>

        <div class="mb-4">
          <label class="block font-semibold mb-2 text-sm text-gray-700">TelÃ©fono del Contacto *</label>
          <input type="tel" id="telefonoContactoRecogida" placeholder="+504 9999-9999" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition">
        </div>

        <div class="mb-4">
          <label class="block font-semibold mb-2 text-sm text-gray-700">Â¿DÃ³nde entregar el paquete? *</label>
          <select id="destinoPaquete" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition">
            <option value="">Selecciona destino</option>
            <option value="tienda1" data-gps="15.6100,-87.9533">Mi Tienda Principal - Choloma</option>
            <option value="tienda2" data-gps="15.5000,-88.0300">Sucursal SPS - San Pedro Sula</option>
            <option value="tienda3" data-gps="14.0800,-87.2100">Bodega Central - Tegucigalpa</option>
            <option value="otra">Otra ubicaciÃ³n</option>
          </select>
        </div>

        <div id="otraUbicacionDestino" class="hidden mb-4">
          <label class="block font-semibold mb-2 text-sm text-gray-700">UbicaciÃ³n de Entrega</label>
          <input type="text" id="ubicacionEntregaOtra" placeholder="Coordenadas: 15.6100,-87.9533" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition">
        </div>
      </div>

      <!-- SECCIÃ“N: REALIZAR COMPRA -->
      <div id="seccionRealizarCompra" class="form-section hidden">
        <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
          <span>ðŸ›’</span> Realizar Compra por Encargo
        </h3>

        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-lg mb-4">
          <p class="text-sm text-blue-800">
            <span class="font-bold">ðŸ“ Nota:</span> Nuestro delivery irÃ¡ al comercio indicado, comprarÃ¡ los productos que solicites y te los entregarÃ¡. Se cobrarÃ¡ el costo de los productos + tarifa de envÃ­o + comisiÃ³n de servicio.
          </p>
        </div>

        <div class="mb-4">
          <label class="block font-semibold mb-2 text-sm text-gray-700">Â¿DÃ³nde realizar la compra? *</label>
          <input type="text" id="nombreComercioCompra" placeholder="Ej: Supermercado La Colonia" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition">
        </div>

        <div class="mb-4">
          <label class="block font-semibold mb-2 text-sm text-gray-700">UbicaciÃ³n del Comercio *</label>
          <input type="text" id="ubicacionComercioCompra" placeholder="Coordenadas: 15.6100,-87.9533" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition">
        </div>

        <div class="mb-4">
          <label class="block font-semibold mb-2 text-sm text-gray-700">Lista de Productos a Comprar *</label>
          <textarea id="listaProductosCompra" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition" rows="4" placeholder="Ejemplo:
- 2 kg de arroz
- 1 litro de aceite vegetal
- 500g de frijoles negros"></textarea>
        </div>

        <div class="mb-4">
          <label class="block font-semibold mb-2 text-sm text-gray-700">Presupuesto Aproximado (L.) *</label>
          <input type="number" id="presupuestoCompra" placeholder="0.00" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition" min="0" step="0.01">
          <p class="text-xs text-gray-500 mt-1">Monto estimado para la compra (no incluye envÃ­o ni comisiÃ³n)</p>
        </div>

        <div class="mb-4">
          <label class="block font-semibold mb-2 text-sm text-gray-700">Â¿DÃ³nde entregar la compra? *</label>
          <select id="destinoCompra" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition">
            <option value="">Selecciona destino</option>
            <option value="tienda1" data-gps="15.6100,-87.9533">Mi Tienda Principal - Choloma</option>
            <option value="tienda2" data-gps="15.5000,-88.0300">Sucursal SPS - San Pedro Sula</option>
            <option value="tienda3" data-gps="14.0800,-87.2100">Bodega Central - Tegucigalpa</option>
          </select>
        </div>
      </div>

      <!-- SECCIÃ“N COMÃšN: DescripciÃ³n del Contenido -->
      <div class="mb-4 mt-6 pt-6 border-t">
        <label class="block font-semibold mb-2 text-sm text-gray-700">DescripciÃ³n del Contenido *</label>
        <textarea id="descripcionContenido" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition" rows="3" placeholder="Describe quÃ© se va a trasladar/recoger"></textarea>
      </div>

      <!-- Foto Opcional -->
      <div class="mb-4">
        <label class="block font-semibold mb-2 text-sm text-gray-700">ðŸ“¸ Foto del Paquete (Opcional)</label>
        <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-brand-orange transition cursor-pointer" id="uploadAreaEntrega">
          <input type="file" id="fotoEntrega" accept="image/*" class="hidden">
          <div id="uploadPlaceholderEntrega">
            <div class="text-5xl mb-2">ðŸ“¸</div>
            <p class="text-sm text-gray-600 font-semibold">Click para subir foto</p>
            <p class="text-xs text-gray-500 mt-1">JPG, PNG (mÃ¡x. 5MB)</p>
          </div>
          <div id="uploadPreviewEntrega" class="hidden">
            <img id="previewImgEntrega" class="mx-auto max-h-40 rounded-lg mb-2">
            <p class="text-sm text-green-600 font-semibold">âœ“ Foto cargada</p>
            <button type="button" id="removeFotoEntrega" class="text-xs text-red-500 hover:text-red-700 mt-2">Cambiar imagen</button>
          </div>
        </div>
      </div>

      <!-- MÃ©todo de Pago -->
      <div class="mb-4">
        <label class="block font-semibold mb-3 text-gray-700">ðŸ’³ MÃ©todo de Pago del EnvÃ­o *</label>
        <div class="grid grid-cols-2 gap-3">
          <label class="relative cursor-pointer">
            <input type="radio" name="metodoPagoEntrega" value="EFECTIVO" class="peer sr-only" checked>
            <div class="border-2 border-gray-200 rounded-xl p-4 text-center peer-checked:border-brand-orange peer-checked:bg-orange-50 transition">
              <div class="text-2xl mb-1">ðŸ’µ</div>
              <div class="font-semibold">Efectivo</div>
            </div>
          </label>
          <label class="relative cursor-pointer">
            <input type="radio" name="metodoPagoEntrega" value="TRANSFERENCIA" class="peer sr-only">
            <div class="border-2 border-gray-200 rounded-xl p-4 text-center peer-checked:border-brand-orange peer-checked:bg-orange-50 transition">
              <div class="text-2xl mb-1">ðŸ¦</div>
              <div class="font-semibold">Transferencia</div>
            </div>
          </label>
        </div>
      </div>

      <!-- Notas Adicionales -->
      <div class="mb-6">
        <label class="block font-semibold mb-2 text-sm text-gray-700">ðŸ“ Notas Adicionales (Opcional)</label>
        <textarea id="notasAdicionalesEntrega" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition" rows="2" placeholder="Instrucciones especiales, horarios preferidos, etc."></textarea>
      </div>

      <!-- Resumen de Tarifa -->
      <div id="resumenTarifaEntrega" class="hidden mb-6 p-4 bg-blue-50 border-2 border-blue-200 rounded-xl">
        <h3 class="font-bold mb-3 flex items-center gap-2">
          ðŸ’° Estimado de Costo
          <span id="modoNocturnoIndicadorEntrega" class="hidden text-xs bg-purple-600 text-white px-2 py-1 rounded-full">ðŸŒ™ Modo Nocturno</span>
        </h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-700">Distancia:</span>
            <span class="font-semibold" id="distanciaKmEntrega">-</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-700">Tarifa Base:</span>
            <span class="font-semibold">L.<span id="tarifaBaseEntrega">0.00</span></span>
          </div>
          <div id="recargoNocturnoRowEntrega" class="hidden flex justify-between text-purple-700">
            <span class="font-semibold">ðŸŒ™ Recargo Nocturno:</span>
            <span class="font-bold">+L.<span id="tarifaRecargoNocturnoEntrega">0.00</span></span>
          </div>
          <div id="comisionCompraRow" class="hidden flex justify-between text-green-700">
            <span class="font-semibold">ðŸ›’ ComisiÃ³n de compra (10%):</span>
            <span class="font-bold">+L.<span id="comisionCompra">0.00</span></span>
          </div>
          <div class="flex justify-between border-t pt-2 mt-2">
            <span class="text-gray-700 font-bold">Total Estimado:</span>
            <span class="font-bold text-lg brand-orange">L.<span id="tarifaTotalEntrega">0.00</span></span>
          </div>
        </div>
      </div>

      <!-- Botones -->
      <div class="flex gap-3">
        <button type="button" id="cancelarSolicitudEntrega" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-4 rounded-xl font-bold transition">
          Cancelar
        </button>
        <button type="submit" class="flex-1 bg-brand-orange text-white py-4 rounded-xl font-bold text-lg hover:bg-orange-600 transition shadow-lg">
          ðŸš€ Solicitar Entrega
        </button>
      </div>
    </form>
  </div>
</div>
  </div>

  <!-- Modal Mapa Interactivo -->
  <div id="mapModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-2xl w-full scale-in">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Selecciona UbicaciÃ³n en el Mapa</h2>
          <button id="closeMapModal" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div id="mapInteractive"></div>
        <p class="text-sm text-gray-600 mt-3 mb-4">Haz clic en el mapa o arrastra el marcador</p>
        <button id="confirmarUbicacion" class="w-full bg-brand-orange text-white py-3 rounded-xl font-bold hover:bg-orange-600 transition">
          Confirmar UbicaciÃ³n
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Ayuda WhatsApp -->
  <div id="ayudaWhatsappModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[80] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-md w-full scale-in">
      <div class="p-6">
        <div class="text-center mb-4">
          <span class="text-5xl">ðŸ“±</span>
          <h2 class="text-xl font-bold mt-2">Â¿CÃ³mo obtener la ubicaciÃ³n de WhatsApp?</h2>
        </div>
        
        <div class="space-y-4 text-sm">
          <div class="bg-green-50 p-3 rounded-lg">
            <p class="font-semibold text-green-800 mb-2">Si te mandaron el PIN de ubicaciÃ³n:</p>
            <ol class="list-decimal list-inside text-green-700 space-y-1">
              <li>Toca el mensaje de ubicaciÃ³n</li>
              <li>Se abrirÃ¡ Google Maps</li>
              <li>Toca y mantÃ©n sobre el pin rojo</li>
              <li>AparecerÃ¡n las coordenadas abajo</li>
              <li>Ej: 15.611781, -87.956879</li>
              <li>TÃ³calas para copiarlas</li>
              <li>PÃ©galas en el formulario</li>
              <li>O manda la ubicaciÃ³n al Whatsapp para que te genere las coordenadas</li>
            </ol>
          </div>
          
      
        </div>
        
        <button id="cerrarAyudaWhatsapp" class="w-full bg-brand-orange text-white py-3 rounded-xl font-bold hover:bg-orange-600 transition mt-4">
          Entendido
        </button>
      </div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = window.APP_CONFIG.apiEndpoint;
const CLOUDINARY_CLOUD_NAME = window.APP_CONFIG.cloudinary.cloudName;
const CLOUDINARY_UPLOAD_PRESET = window.APP_CONFIG.cloudinary.uploadPreset;

// Validar origen al cargar
if (!window.APP_SECURITY.validateOrigin()) {
  document.body.innerHTML = '<h1 style="text-align:center;margin-top:50px;">Acceso no autorizado</h1>';
  throw new Error('Invalid origin');
}

    let appData = {
      comercio: null,
      ubicacionRecogida: null,
      ubicacionEntrega: null,
      mapRecogida: null,
      mapEntrega: null,
      mapInteractive: null,
      markerInteractive: null,
      envios: [],
      solicitudes: []
    };

    // AUTENTICACIÃ“N
    function verificarSesion() {
  const comercioGuardado = window.APP_SECURITY.getSecureSession('somarComercioUser');
  if (comercioGuardado) {
    try {
      appData.comercio = comercioGuardado;
          document.getElementById('authModal').classList.add('hidden');
          document.getElementById('mainContent').classList.remove('hidden');
          document.getElementById('comercioName').textContent = appData.comercio.nombre;
          document.getElementById('direccionRecogidaDisplay').textContent = appData.comercio.direccion;
          appData.ubicacionRecogida = appData.comercio.ubicacionGPS;
          cargarMisSolicitudes();
          return true;
          
        } catch (error) {
          localStorage.removeItem('somarComercioUser');
        }
      }
      return false;
    }

    async function enviarCodigoVerificacion(numero) {
      try {
        const submitBtn = document.querySelector('#authPhoneForm button[type="submit"]');
        submitBtn.textContent = 'Enviando...';
        submitBtn.disabled = true;

        await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'enviarCodigoVerificacionComercio',
            numero: numero
          })
        });

        appData.numeroTemporal = numero;
        document.getElementById('phoneDisplay').textContent = numero;
        document.getElementById('authStep1').classList.add('hidden');
        document.getElementById('authStep2').classList.remove('hidden');
        submitBtn.textContent = 'Continuar';
        submitBtn.disabled = false;
        alert('âœ… CÃ³digo enviado por WhatsApp');
      } catch (error) {
        console.error('Error:', error);
        alert('âš ï¸ Error al enviar cÃ³digo');
      }
    }

    async function verificarCodigoIngresado(codigo) {
      try {
        const submitBtn = document.querySelector('#authCodeForm button[type="submit"]');
        submitBtn.textContent = 'Verificando...';
        submitBtn.disabled = true;

        const url = `${SCRIPT_URL}?action=verificarCodigoComercio&numero=${encodeURIComponent(appData.numeroTemporal)}&codigo=${encodeURIComponent(codigo)}`;
        const response = await fetch(url);
        const result = await response.json();

        if (result.success) {
          if (result.comercioExiste) {
            appData.comercio = result.datosComercio;
            window.APP_SECURITY.saveSecureSession('somarComercioUser', appData.comercio);
            document.getElementById('authModal').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('comercioName').textContent = appData.comercio.nombre;
            document.getElementById('direccionRecogidaDisplay').textContent = appData.comercio.direccion;
            appData.ubicacionRecogida = appData.comercio.ubicacionGPS;
            cargarMisSolicitudes(); 
            alert(`Â¡Bienvenido ${result.datosComercio.nombre}!`);
          } else {
            document.getElementById('authStep2').classList.add('hidden');
            document.getElementById('authStep3').classList.remove('hidden');
          }
        } else {
          alert(result.error || 'CÃ³digo incorrecto');
          submitBtn.textContent = 'Verificar';
          submitBtn.disabled = false;
        }
      } catch (error) {
        console.error('Error:', error);
        alert('âš ï¸ Error al verificar cÃ³digo');
      }
    }

    async function completarRegistroComercio(nombre, direccion, ubicacionGPS) {
      try {
        const submitBtn = document.querySelector('#authRegisterForm button[type="submit"]');
        submitBtn.textContent = 'Registrando...';
        submitBtn.disabled = true;

        const params = new URLSearchParams({
          action: 'completarRegistroComercio',
          celular: appData.numeroTemporal,
          nombre: nombre,
          direccion: direccion,
          ubicacionGPS: ubicacionGPS || ''
        });

        const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
        const result = await response.json();

        if (result.success) {
          appData.comercio = result.comercio;
          window.APP_SECURITY.saveSecureSession('somarComercioUser', appData.comercio);
          document.getElementById('authModal').classList.add('hidden');
          document.getElementById('mainContent').classList.remove('hidden');
          document.getElementById('comercioName').textContent = appData.comercio.nombre;
          document.getElementById('direccionRecogidaDisplay').textContent = appData.comercio.direccion;
          appData.ubicacionRecogida = appData.comercio.ubicacionGPS;
          cargarMisSolicitudes();
          alert('Â¡Comercio registrado exitosamente!');
        } else {
          alert(result.error || 'Error al registrar');
          submitBtn.textContent = 'Registrar Comercio';
          submitBtn.disabled = false;
        }
      } catch (error) {
        console.error('Error:', error);
        alert('âš ï¸ Error al registrar');
      }
    }

    function cerrarSesion() {
      if (confirm('Â¿Cerrar sesiÃ³n?')) {
        localStorage.removeItem('somarComercioUser');
        location.reload();
      }
    }

    // EXTRACCIÃ“N DE COORDENADAS
    async function extraerCoordenadasDeLink(input) {
      try {
        input = input.trim();
        window.secureLog('ðŸ” Procesando entrada:', input);

        const soloCoordMatch = input.match(/^\s*([0-9]{1,2}\.[0-9]+)\s*,\s*(-?[0-9]{1,3}\.[0-9]+)\s*$/);
        if (soloCoordMatch) {
          const lat = parseFloat(soloCoordMatch[1]);
          const lon = parseFloat(soloCoordMatch[2]);
          
          if (lat >= 13 && lat <= 16 && lon >= -90 && lon <= -83) {
            window.secureLog('âœ… Coordenadas directas detectadas');
            return { lat, lon, exito: true };
          }
        }

        if (input.includes('goo.gl') || input.includes('maps.app.goo.gl')) {
          window.secureLog('âš ï¸ Link acortado detectado');
          return { 
            exito: false, 
            error: 'LINK_ACORTADO',
            mensaje: 'Link acortado detectado.\n\nPor favor:\n1. Abre el link en Google Maps\n2. Espera que cargue\n3. Toca y mantÃ©n sobre la ubicaciÃ³n\n4. AparecerÃ¡n las coordenadas abajo\n5. CÃ³pialas y pÃ©galas aquÃ­\n\nO usa el mapa interactivo ðŸ—ºï¸'
          };
        }

        return await extraerCoordenadasDeURL(input);

      } catch (error) {
        console.error('âŒ Error:', error);
        return { exito: false, error: error.toString() };
      }
    }

    async function extraerCoordenadasDeURL(url) {
      const qMatch = url.match(/[?&]q=([0-9.-]+),([0-9.-]+)/);
      if (qMatch) {
        window.secureLog('âœ… Coordenadas encontradas (q)');
        return { lat: parseFloat(qMatch[1]), lon: parseFloat(qMatch[2]), exito: true };
      }

      const atMatch = url.match(/@([0-9.-]+),([0-9.-]+)/);
      if (atMatch) {
        window.secureLog('âœ… Coordenadas encontradas (@)');
        return { lat: parseFloat(atMatch[1]), lon: parseFloat(atMatch[2]), exito: true };
      }

      const placeMatch = url.match(/\/place\/.*?@([0-9.-]+),([0-9.-]+)/);
      if (placeMatch) {
        window.secureLog('âœ… Coordenadas encontradas (place)');
        return { lat: parseFloat(placeMatch[1]), lon: parseFloat(placeMatch[2]), exito: true };
      }

      const coordMatch = url.match(/([0-9]{1,2}\.[0-9]{4,})[,\s]+(-?[0-9]{1,3}\.[0-9]{4,})/);
      if (coordMatch) {
        const lat = parseFloat(coordMatch[1]);
        const lon = parseFloat(coordMatch[2]);
        
        if (lat >= 13 && lat <= 16 && lon >= -90 && lon <= -83) {
          window.secureLog('âœ… Coordenadas encontradas (patrÃ³n general)');
          return { lat, lon, exito: true };
        }
      }

      window.secureLog('âŒ No se encontraron coordenadas en la URL');
      return { exito: false, error: 'No se detectaron coordenadas vÃ¡lidas' };
    }

    // CÃLCULO DE TARIFAS
    function calcularDistanciaHaversine(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function obtenerCiudad(lat, lon) {
      const ciudades = [
        { nombre: 'Choloma', lat: 15.61, lon: -87.95, radio: 0.10 },
        { nombre: 'San Pedro Sula', lat: 15.50, lon: -88.03, radio: 0.15 },
        { nombre: 'Tegucigalpa', lat: 14.08, lon: -87.21, radio: 0.15 },
        { nombre: 'La Ceiba', lat: 15.78, lon: -86.80, radio: 0.10 },
        { nombre: 'El Progreso', lat: 15.40, lon: -87.80, radio: 0.08 },
        { nombre: 'Comayagua', lat: 14.45, lon: -87.64, radio: 0.10 },
        { nombre: 'Puerto CortÃ©s', lat: 15.85, lon: -87.94, radio: 0.08 },
        { nombre: 'Villanueva', lat: 15.32, lon: -88.00, radio: 0.08 },
        { nombre: 'La Lima', lat: 15.43, lon: -87.91, radio: 0.06 },
        { nombre: 'Choluteca', lat: 13.30, lon: -87.19, radio: 0.10 },
        { nombre: 'DanlÃ­', lat: 14.03, lon: -86.58, radio: 0.08 },
        { nombre: 'Juticalpa', lat: 14.66, lon: -86.22, radio: 0.08 },
        { nombre: 'Santa Rosa de CopÃ¡n', lat: 14.77, lon: -88.78, radio: 0.08 },
        { nombre: 'Siguatepeque', lat: 14.60, lon: -87.84, radio: 0.08 },
        { nombre: 'Tocoa', lat: 15.66, lon: -86.00, radio: 0.08 },
        { nombre: 'Tela', lat: 15.78, lon: -87.46, radio: 0.08 }
      ];

      for (const ciudad of ciudades) {
        const distancia = Math.sqrt(Math.pow(lat - ciudad.lat, 2) + Math.pow(lon - ciudad.lon, 2));
        if (distancia < ciudad.radio) {
          window.secureLog(`âœ… Ciudad detectada: ${ciudad.nombre}`);
          return ciudad.nombre;
        }
      }

      if (lat >= 15.3 && lat <= 16.0 && lon >= -88.5 && lon <= -87.3) return 'CortÃ©s';
      else if (lat >= 13.8 && lat <= 14.4 && lon >= -87.5 && lon <= -86.8) return 'Francisco MorazÃ¡n';
      else if (lat >= 15.5 && lat <= 16.0 && lon >= -87.0 && lon <= -86.0) return 'AtlÃ¡ntida';
      else if (lat >= 14.4 && lat <= 15.0 && lon >= -86.8 && lon <= -86.0) return 'Olancho';
      else if (lat >= 13.0 && lat <= 13.8 && lon >= -87.5 && lon <= -86.8) return 'Choluteca';

      window.secureLog('âš ï¸ Ciudad no detectada, usando genÃ©rico');
      return 'Honduras';
    }

    async function calcularDistanciaOSRM(lat1, lon1, lat2, lon2) {
      try {
        const url = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=false`;
        window.secureLog('ðŸŒ Consultando OSRM...');
        const response = await fetch(url);
        if (!response.ok) throw new Error('OSRM failed');
        const data = await response.json();
        if (data.code !== 'Ok' || !data.routes || data.routes.length === 0) throw new Error('No route');
        const distanciaKm = data.routes[0].distance / 1000;
        window.secureLog(`âœ… OSRM: ${distanciaKm.toFixed(2)} km por carretera`);
        return distanciaKm;
      } catch (error) {
        console.error('âŒ OSRM error:', error);
        throw error;
      }
    }

    function calcularTarifaCholoma(km) {
      const tabla = [
        { min: 0, max: 3, tarifa: 50 },
        { min: 3, max: 7, tarifa: 75 },
        { min: 7, max: 9, tarifa: 90 },
        { min: 9, max: 11, tarifa: 105 },
        { min: 11, max: 13, tarifa: 120 },
        { min: 13, max: 15, tarifa: 135 }
      ];
      for (const r of tabla) {
        if (km >= r.min && km < r.max) {
          window.secureLog(`âœ… Choloma ${r.min}-${r.max}km: L.${r.tarifa}`);
          return r.tarifa;
        }
      }
      const calc = 30 + (km * 6.8);
      const redondeado = Math.round(calc / 5) * 5;
      window.secureLog(`ðŸ“Š Choloma fuera de tabla: ${calc.toFixed(2)} â†’ L.${redondeado}`);
      return redondeado;
    }

    function calcularTarifaOtrasCiudades(km) {
      const tabla = [
        { min: 0, max: 11, tarifa: 125 },
        { min: 11, max: 13, tarifa: 135 },
        { min: 13, max: 15, tarifa: 150 },
        { min: 15, max: 17, tarifa: 165 },
        { min: 17, max: 19, tarifa: 180 },
        { min: 19, max: 21, tarifa: 195 }
      ];
      for (const r of tabla) {
        if (km >= r.min && km < r.max) {
          window.secureLog(`âœ… Otras ${r.min}-${r.max}km: L.${r.tarifa}`);
          return r.tarifa;
        }
      }
      const calc = 40 + (km * 7.5);
      const redondeado = Math.round(calc / 5) * 5;
      window.secureLog(`ðŸ“Š Otras fuera de tabla: ${calc.toFixed(2)} â†’ L.${redondeado}`);
      return redondeado;
    }

    async function calcularTarifa(ubicacionRecogida, ubicacionEntrega) {
      if (!ubicacionRecogida || !ubicacionEntrega) {
        window.secureLog('âš ï¸ Faltan ubicaciones');
        return;
      }

      try {
        const [lat1, lon1] = ubicacionRecogida.split(',').map(Number);
        const [lat2, lon2] = ubicacionEntrega.split(',').map(Number);

        if (isNaN(lat1) || isNaN(lon1) || isNaN(lat2) || isNaN(lon2)) {
          console.error('âŒ Coordenadas invÃ¡lidas');
          return;
        }

        const ciudadOrigen = obtenerCiudad(lat1, lon1);
        const ciudadDestino = obtenerCiudad(lat2, lon2);

        window.secureLog(`ðŸ“ Origen: ${ciudadOrigen}, Destino: ${ciudadDestino}`);

        let distanciaKm;
        try {
          distanciaKm = await calcularDistanciaOSRM(lat1, lon1, lat2, lon2);
        } catch (error) {
          console.warn('âš ï¸ OSRM fallback a Haversine');
          distanciaKm = calcularDistanciaHaversine(lat1, lon1, lat2, lon2);
        }

        const esCholoma = ciudadOrigen.toLowerCase().includes('choloma') && 
                          ciudadDestino.toLowerCase().includes('choloma');

        const tarifaTotal = esCholoma ? 
          calcularTarifaCholoma(distanciaKm) : 
          calcularTarifaOtrasCiudades(distanciaKm);

        document.getElementById('ciudadOrigen').textContent = ciudadOrigen;
        document.getElementById('ciudadDestino').textContent = ciudadDestino;
        document.getElementById('distanciaKm').textContent = distanciaKm.toFixed(2) + ' km';
        document.getElementById('tarifaTotal').textContent = tarifaTotal.toFixed(2);
        document.getElementById('tarifaResumen').classList.remove('hidden');

        window.secureLog(`âœ… Tarifa: L.${tarifaTotal.toFixed(2)}`);
      } catch (error) {
        console.error('âŒ Error:', error);
      }
    }

    // MAPAS
    function mostrarMapaPreview(lat, lon, containerId) {
      window.secureLog(`ðŸ—ºï¸ Mostrando mapa preview en ${containerId}:`, lat, lon);
      
      const container = document.getElementById(containerId);
      if (!container) {
        console.error('âŒ Contenedor no encontrado:', containerId);
        return;
      }

      if (containerId === 'mapPreviewRecogida' && appData.mapRecogida) {
        try {
          appData.mapRecogida.off();
          appData.mapRecogida.remove();
        } catch (error) {
          window.secureLog('âš ï¸ Error limpiando mapa recogida:', error);
        }
        appData.mapRecogida = null;
      }
      
      if (containerId === 'mapPreviewEntrega' && appData.mapEntrega) {
        try {
          appData.mapEntrega.off();
          appData.mapEntrega.remove();
        } catch (error) {
          window.secureLog('âš ï¸ Error limpiando mapa entrega:', error);
        }
        appData.mapEntrega = null;
      }
      
      container.innerHTML = '';
      container.className = '';
      
      const newContainer = document.createElement('div');
      newContainer.id = containerId;
      newContainer.style.height = '250px';
      newContainer.style.borderRadius = '12px';
      newContainer.style.overflow = 'hidden';
      newContainer.style.position = 'relative';
      newContainer.className = 'mb-2';
      
      container.parentNode.replaceChild(newContainer, container);
      newContainer.classList.remove('hidden');
      
      setTimeout(() => {
        try {
          const map = L.map(containerId, {
            center: [lat, lon],
            zoom: 15,
            zoomControl: true,
            scrollWheelZoom: false
          });
          
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap',
            maxZoom: 18
          }).addTo(map);
          
          L.marker([lat, lon]).addTo(map);
          
          if (containerId === 'mapPreviewRecogida') {
            appData.mapRecogida = map;
          } else if (containerId === 'mapPreviewEntrega') {
            appData.mapEntrega = map;
          }
          
          setTimeout(() => map.invalidateSize(), 150);
          window.secureLog(`âœ… Mapa ${containerId} creado`);
          
        } catch (error) {
          console.error(`âŒ Error creando mapa ${containerId}:`, error);
        }
      }, 250);
    }

    function inicializarMapaInteractivo() {
      window.secureLog('ðŸ—ºï¸ Inicializando mapa interactivo...');
      
      const modal = document.getElementById('mapModal');
      const container = document.getElementById('mapInteractive');

      if (appData.mapInteractive) {
        try {
          appData.mapInteractive.off();
          appData.mapInteractive.remove();
        } catch (error) {
          window.secureLog('âš ï¸ Error limpiando mapa:', error);
        }
        appData.mapInteractive = null;
        appData.markerInteractive = null;
      }

      container.innerHTML = '';
      container.className = '';
      
      const newContainer = document.createElement('div');
      newContainer.id = 'mapInteractive';
      newContainer.style.height = '250px';
      newContainer.style.borderRadius = '12px';
      newContainer.style.overflow = 'hidden';
      newContainer.style.position = 'relative';
      
      container.parentNode.replaceChild(newContainer, container);
      modal.classList.remove('hidden');

      setTimeout(() => {
        try {
          let centerLat = 15.5;
          let centerLon = -88.0;
          
          if (appData.comercio && appData.comercio.ubicacionGPS) {
            const coords = appData.comercio.ubicacionGPS.split(',');
            if (coords.length === 2) {
              centerLat = parseFloat(coords[0]);
              centerLon = parseFloat(coords[1]);
            }
          }
          
          appData.mapInteractive = L.map('mapInteractive', {
            center: [centerLat, centerLon],
            zoom: 13,
            zoomControl: true
          });
          
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap',
            maxZoom: 18
          }).addTo(appData.mapInteractive);

          appData.markerInteractive = L.marker([centerLat, centerLon], { 
            draggable: true 
          }).addTo(appData.mapInteractive);

          appData.mapInteractive.on('click', (e) => {
            appData.markerInteractive.setLatLng(e.latlng);
          });
          
          setTimeout(() => appData.mapInteractive.invalidateSize(), 200);
          window.secureLog('âœ… Mapa interactivo creado');
        } catch (error) {
          console.error('âŒ Error:', error);
          alert('Error al cargar el mapa. Intenta de nuevo.');
        }
      }, 250);
    }

    // GESTIÃ“N DE ENVÃOS
    async function cargarMisSolicitudes() {
  try {
    const url = `${SCRIPT_URL}?action=obtenerEnviosComercio&idComercio=${appData.comercio.id}`;
    const response = await fetch(url);
    const result = await response.json();

    if (result.success) {
      appData.solicitudes = result.envios; // Incluye tanto envÃ­os como entregas
      renderizarSolicitudes();
    }
  } catch (error) {
    console.error('Error:', error);
  }
}

    function renderizarSolicitudes() {
  const container = document.getElementById('listaSolicitudes');
  const filtroEstado = document.getElementById('filtroEstado').value;
  const filtroTipo = document.getElementById('filtroTipo').value;

  let solicitudesFiltradas = appData.solicitudes || [];
  
  // Filtrar por estado
  if (filtroEstado) {
    solicitudesFiltradas = solicitudesFiltradas.filter(s => s.estado === filtroEstado);
  }
  
  // Filtrar por tipo (ENVIO o ENTREGA)
  if (filtroTipo) {
    if (filtroTipo === 'ENVIO') {
      solicitudesFiltradas = solicitudesFiltradas.filter(s => !s.esEntrega && !s.tipoRegistro);
    } else if (filtroTipo === 'ENTREGA') {
      solicitudesFiltradas = solicitudesFiltradas.filter(s => s.esEntrega || s.tipoRegistro === 'SOLICITUD_ENTREGA');
    }
  }

  if (solicitudesFiltradas.length === 0) {
    container.innerHTML = '<div class="text-center py-12 text-gray-500"><p>No hay solicitudes para mostrar</p></div>';
    return;
  }

  container.innerHTML = solicitudesFiltradas.map(item => {
    const esEntrega = item.esEntrega || item.tipoRegistro === 'SOLICITUD_ENTREGA';
    const tipoIcono = esEntrega ? 'ðŸšš' : 'ðŸ“¦';
    const tipoTexto = esEntrega ? 'SOLICITUD ENTREGA' : 'ENVÃO';
    
    // Determinar subtipo de entrega
    let subtipoEntrega = '';
    if (esEntrega && item.tipoServicio) {
      const subtipos = {
        'TRASLADO_TIENDAS': 'ðŸª Traslado entre Tiendas',
        'RECOGER_PAQUETE': 'ðŸ“¦ Recoger Paquete',
        'REALIZAR_COMPRA': 'ðŸ›’ Realizar Compra'
      };
      subtipoEntrega = subtipos[item.tipoServicio] || '';
    }
    
    return `
      <div class="bg-white rounded-xl shadow-sm p-4 hover:shadow-md transition ${esEntrega ? 'border-l-4 border-orange-400' : ''}">
        <div class="flex justify-between items-start mb-3">
          <div>
            <div class="flex items-center gap-2 mb-1">
              <span class="text-xl">${tipoIcono}</span>
              <p class="font-bold text-lg">${tipoTexto} #${item.id || 'N/A'}</p>
            </div>
            <p class="text-sm text-gray-600">${new Date(item.fecha || item.fechaSolicitud).toLocaleString('es-HN')}</p>
            ${subtipoEntrega ? `<p class="text-xs text-orange-600 font-semibold mt-1">${subtipoEntrega}</p>` : ''}
          </div>
          <span class="status-badge status-${item.estado}">${item.estado.replace(/_/g, ' ')}</span>
        </div>
        
        <div class="grid grid-cols-2 gap-2 text-sm mb-3">
          ${!esEntrega ? `
            <div>
              <p class="text-gray-500">Origen:</p>
              <p class="font-semibold">${item.ciudadOrigen || '-'}</p>
            </div>
            <div>
              <p class="text-gray-500">Destino:</p>
              <p class="font-semibold">${item.ciudadDestino || '-'}</p>
            </div>
            <div>
              <p class="text-gray-500">Destinatario:</p>
              <p class="font-semibold">${item.nombreDestinatario || '-'}</p>
            </div>
            <div>
              <p class="text-gray-500">Tipo:</p>
              <p class="font-semibold">${item.tipoServicio === 'PAGO_CONTRA_ENTREGA' ? 'ðŸ’° Contra Entrega' : 'ðŸ“¦ Solo Entrega'}</p>
            </div>
          ` : `
            <div>
              <p class="text-gray-500">Tarifa:</p>
              <p class="font-semibold brand-orange">L.${item.tarifa || item.tarifaEstimada || '0.00'}</p>
            </div>
            <div>
              <p class="text-gray-500">MÃ©todo de Pago:</p>
              <p class="font-semibold">${item.metodoPago === 'EFECTIVO' ? 'ðŸ’µ Efectivo' : 'ðŸ¦ Transferencia'}</p>
            </div>
          `}
        </div>
        
        ${item.delivery ? `<p class="text-sm text-blue-600">ðŸšš Delivery: ${item.delivery}</p>` : ''}
        <p class="text-sm text-gray-600 mt-2">${item.descripcionPaquete || item.descripcionContenido || 'Sin descripciÃ³n'}</p>
        
        ${item.fotoUrl ? `
          <div class="mt-3">
            <img src="${item.fotoUrl}" alt="Foto" class="w-full max-h-40 object-cover rounded-lg cursor-pointer" onclick="window.open('${item.fotoUrl}', '_blank')">
          </div>
        ` : ''}
      </div>
    `;
  }).join('');
}

    async function procesarEnvio(e) {
      e.preventDefault();

      if (!appData.ubicacionRecogida) {
        alert('âš ï¸ Debes configurar la ubicaciÃ³n de recogida');
        return;
      }

      if (!appData.ubicacionEntrega) {
        alert('âš ï¸ Debes pegar la ubicaciÃ³n de entrega que te mandÃ³ tu cliente por WhatsApp');
        document.getElementById('linkEntrega').focus();
        return;
      }

      const tipoServicio = document.querySelector('input[name="tipoServicio"]:checked').value;
      const quienPaga = document.querySelector('input[name="quienPaga"]:checked').value;
      const nombreDestinatario = document.getElementById('nombreDestinatario').value;
      const telefonoDestinatario = document.getElementById('telefonoDestinatario').value;
      const descripcionPaquete = document.getElementById('descripcionPaquete').value;
      const montoCobrar = tipoServicio === 'PAGO_CONTRA_ENTREGA' ? document.getElementById('montoCobrar').value : 0;
      const tipoPagoEnvio = document.querySelector('input[name="tipoPagoEnvio"]:checked').value;
      const notasAdicionales = document.getElementById('notasAdicionales').value;

      let fotoUrl = null;
      const fotoFile = document.getElementById('fotoPaquete').files[0];

      const submitBtn = document.querySelector('#nuevoEnvioForm button[type="submit"]');
      submitBtn.textContent = 'Procesando...';
      submitBtn.disabled = true;

      if (fotoFile) {
        try {
          const formData = new FormData();
          formData.append('file', fotoFile);
          formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
          formData.append('cloud_name', CLOUDINARY_CLOUD_NAME);

          const cloudinaryResponse = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
            method: 'POST',
            body: formData
          });

          const cloudinaryData = await cloudinaryResponse.json();
          fotoUrl = cloudinaryData.secure_url;
        } catch (error) {
          console.error('Error subiendo foto:', error);
        }
      }

      const datos = {
        idComercio: appData.comercio.id,
        nombreComercio: appData.comercio.nombre,
        telefonoComercio: appData.comercio.celular,
        tipoServicio,
        quienPaga,
        ubicacionRecogidaGPS: appData.ubicacionRecogida,
        ubicacionEntregaGPS: appData.ubicacionEntrega,
        nombreDestinatario,
        telefonoDestinatario,
        descripcionPaquete,
        montoCobrar,
        tipoPagoEnvio,
        notasAdicionales,
        fotoUrl,
        ciudadOrigen: document.getElementById('ciudadOrigen').textContent,
        ciudadDestino: document.getElementById('ciudadDestino').textContent,
        distanciaKm: document.getElementById('distanciaKm').textContent,
        tarifaEstimada: document.getElementById('tarifaTotal').textContent
      };

      try {
        await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'registrarEnvioComercio',
            datos: datos
          })
        });

        alert('âœ… EnvÃ­o registrado exitosamente');
        document.getElementById('nuevoEnvioForm').reset();
        document.getElementById('tarifaResumen').classList.add('hidden');
        document.getElementById('uploadPlaceholder').classList.remove('hidden');
        document.getElementById('uploadPreview').classList.add('hidden');
        document.getElementById('ubicacionDetectada').classList.add('hidden');
        submitBtn.textContent = 'ðŸš€ Crear EnvÃ­o';
        submitBtn.disabled = false;
        appData.ubicacionEntrega = null;

        document.getElementById('tabMisEnvios').click();
      } catch (error) {
        console.error('Error:', error);
        alert('âš ï¸ Error al registrar envÃ­o');
        submitBtn.textContent = 'ðŸš€ Crear EnvÃ­o';
        submitBtn.disabled = false;
      }
    }

    // EVENT LISTENERS
    window.addEventListener('DOMContentLoaded', () => {
      verificarSesion();

      document.getElementById('authPhoneForm').addEventListener('submit', (e) => {
        e.preventDefault();
        enviarCodigoVerificacion(document.getElementById('authPhone').value);
      });

      document.getElementById('authCodeForm').addEventListener('submit', (e) => {
        e.preventDefault();
        verificarCodigoIngresado(document.getElementById('authCode').value);
      });

      document.getElementById('authRegisterForm').addEventListener('submit', (e) => {
        e.preventDefault();
        completarRegistroComercio(
          document.getElementById('authNombreComercio').value,
          document.getElementById('authDireccionComercio').value,
          document.getElementById('authUbicacionGPS').value
        );
      });

      document.getElementById('resendCodeBtn').addEventListener('click', () => {
        enviarCodigoVerificacion(appData.numeroTemporal);
      });

      document.getElementById('authCode').addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
      });

      document.getElementById('getLocationBtn').addEventListener('click', () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const gps = `${position.coords.latitude},${position.coords.longitude}`;
              document.getElementById('authUbicacionGPS').value = gps;
            },
            () => alert('No se pudo obtener ubicaciÃ³n')
          );
        }
      });

      document.getElementById('logoutBtn').addEventListener('click', cerrarSesion);

      document.getElementById('tabNuevoEnvio').addEventListener('click', () => {
  // Actualizar estilos de tabs
  document.getElementById('tabNuevoEnvio').classList.add('border-brand-orange', 'brand-orange');
  document.getElementById('tabNuevoEnvio').classList.remove('border-transparent', 'text-gray-500');
  document.getElementById('tabMisSolicitudes').classList.remove('border-brand-orange', 'brand-orange');
  document.getElementById('tabMisSolicitudes').classList.add('border-transparent', 'text-gray-500');
  document.getElementById('tabSolicitarEntrega').classList.remove('border-brand-orange', 'brand-orange');
  document.getElementById('tabSolicitarEntrega').classList.add('border-transparent', 'text-gray-500');
  
  // Mostrar/ocultar contenido
  document.getElementById('contentNuevoEnvio').classList.remove('hidden');
  document.getElementById('contentMisSolicitudes').classList.add('hidden');
  document.getElementById('containerSolicitarEntrega').classList.add('hidden');
});
      });

      document.getElementById('tabMisSolicitudes').addEventListener('click', () => {
  // Actualizar estilos de tabs
  document.getElementById('tabMisSolicitudes').classList.add('border-brand-orange', 'brand-orange');
  document.getElementById('tabMisSolicitudes').classList.remove('border-transparent', 'text-gray-500');
  document.getElementById('tabNuevoEnvio').classList.remove('border-brand-orange', 'brand-orange');
  document.getElementById('tabNuevoEnvio').classList.add('border-transparent', 'text-gray-500');
  document.getElementById('tabSolicitarEntrega').classList.remove('border-brand-orange', 'brand-orange');
  document.getElementById('tabSolicitarEntrega').classList.add('border-transparent', 'text-gray-500');
  
  // Mostrar/ocultar contenido
  document.getElementById('contentMisSolicitudes').classList.remove('hidden');
  document.getElementById('contentNuevoEnvio').classList.add('hidden');
  document.getElementById('containerSolicitarEntrega').classList.add('hidden');
  
  cargarMisSolicitudes();
});

document.getElementById('tabSolicitarEntrega').addEventListener('click', () => {
  // Actualizar estilos de tabs
  document.getElementById('tabSolicitarEntrega').classList.add('border-brand-orange', 'brand-orange');
  document.getElementById('tabSolicitarEntrega').classList.remove('border-transparent', 'text-gray-500');
  document.getElementById('tabNuevoEnvio').classList.remove('border-brand-orange', 'brand-orange');
  document.getElementById('tabNuevoEnvio').classList.add('border-transparent', 'text-gray-500');
  document.getElementById('tabMisSolicitudes').classList.remove('border-brand-orange', 'brand-orange');
  document.getElementById('tabMisSolicitudes').classList.add('border-transparent', 'text-gray-500');
  
  // Mostrar/ocultar contenido
  document.getElementById('containerSolicitarEntrega').classList.remove('hidden');
  document.getElementById('contentNuevoEnvio').classList.add('hidden');
  document.getElementById('contentMisSolicitudes').classList.add('hidden');
  
  // Inicializar mÃ³dulo si existe la funciÃ³n
  if (typeof inicializarSolicitarEntrega === 'function') {
    inicializarSolicitarEntrega();
  }
});

      document.querySelectorAll('input[name="tipoServicio"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          const montoSection = document.getElementById('montoSection');
          if (e.target.value === 'PAGO_CONTRA_ENTREGA') {
            montoSection.classList.remove('hidden');
            document.getElementById('montoCobrar').setAttribute('required', 'required');
          } else {
            montoSection.classList.add('hidden');
            document.getElementById('montoCobrar').removeAttribute('required');
          }
        });
      });

      document.getElementById('cambiarRecogida').addEventListener('click', () => {
        document.getElementById('recogidaCustom').classList.remove('hidden');
      });

      document.getElementById('usarUbicacionGuardada').addEventListener('click', () => {
        document.getElementById('recogidaCustom').classList.add('hidden');
        appData.ubicacionRecogida = appData.comercio.ubicacionGPS;
      });

      let linkEntregaTimeout;
      document.getElementById('linkEntrega').addEventListener('input', (e) => {
        clearTimeout(linkEntregaTimeout);
        
        const statusIndicator = document.getElementById('linkEntregaStatus');
        const input = e.target.value.trim();
        
        document.getElementById('ubicacionDetectada').classList.add('hidden');
        document.getElementById('ubicacionError').classList.add('hidden');
        
        if (input.length > 5) {
          statusIndicator.classList.remove('hidden');
          
          linkEntregaTimeout = setTimeout(async () => {
            window.secureLog('ðŸ” Procesando entrada:', input);
            const resultado = await extraerCoordenadasDeLink(input);
            statusIndicator.classList.add('hidden');
            
            if (resultado.exito) {
              window.secureLog('âœ… Coordenadas extraÃ­das:', resultado.lat, resultado.lon);
              appData.ubicacionEntrega = `${resultado.lat},${resultado.lon}`;
              
              document.getElementById('ubicacionDetectada').classList.remove('hidden');
              document.getElementById('coordenadasDetectadas').textContent = `Lat: ${resultado.lat.toFixed(6)}, Lon: ${resultado.lon.toFixed(6)}`;
              
              mostrarMapaPreview(resultado.lat, resultado.lon, 'mapPreviewEntrega');
              await calcularTarifa(appData.ubicacionRecogida, appData.ubicacionEntrega);
              
              e.target.classList.remove('border-red-500');
              e.target.classList.add('border-green-500');
              
            } else {
              window.secureLog('âŒ No se encontraron coordenadas');
              e.target.classList.remove('border-green-500');
              e.target.classList.add('border-red-500');
              
              document.getElementById('ubicacionError').classList.remove('hidden');
              
              if (resultado.error === 'LINK_ACORTADO') {
                alert(resultado.mensaje);
              }
            }
          }, 1000);
        } else {
          statusIndicator.classList.add('hidden');
          e.target.classList.remove('border-green-500', 'border-red-500');
        }
      });

      document.getElementById('usarMapaInteractivo').addEventListener('click', () => {
        inicializarMapaInteractivo();
      });

      document.getElementById('closeMapModal').addEventListener('click', () => {
        const modal = document.getElementById('mapModal');
        modal.classList.add('hidden');
        
        if (appData.mapInteractive) {
          try {
            appData.mapInteractive.off();
            appData.mapInteractive.remove();
          } catch (error) {}
          appData.mapInteractive = null;
          appData.markerInteractive = null;
        }
        
        const container = document.getElementById('mapInteractive');
        if (container) {
          container.innerHTML = '';
          container.className = '';
        }
      });

      document.getElementById('confirmarUbicacion').addEventListener('click', () => {
        if (!appData.markerInteractive) {
          alert('âš ï¸ Error: No se ha seleccionado ubicaciÃ³n');
          return;
        }

        const latlng = appData.markerInteractive.getLatLng();
        appData.ubicacionEntrega = `${latlng.lat},${latlng.lng}`;
        
        document.getElementById('ubicacionDetectada').classList.remove('hidden');
        document.getElementById('coordenadasDetectadas').textContent = `Lat: ${latlng.lat.toFixed(6)}, Lon: ${latlng.lng.toFixed(6)}`;
        
        document.getElementById('mapModal').classList.add('hidden');
        
        if (appData.mapInteractive) {
          try {
            appData.mapInteractive.off();
            appData.mapInteractive.remove();
          } catch (error) {}
          appData.mapInteractive = null;
          appData.markerInteractive = null;
        }
        
        const container = document.getElementById('mapInteractive');
        if (container) {
          container.innerHTML = '';
          container.className = '';
        }
        
        setTimeout(() => {
          mostrarMapaPreview(latlng.lat, latlng.lng, 'mapPreviewEntrega');
          setTimeout(async () => {
            await calcularTarifa(appData.ubicacionRecogida, appData.ubicacionEntrega);
          }, 500);
        }, 300);
      });

      document.getElementById('abrirAyudaWhatsapp').addEventListener('click', () => {
        document.getElementById('ayudaWhatsappModal').classList.remove('hidden');
      });

      document.getElementById('cerrarAyudaWhatsapp').addEventListener('click', () => {
        document.getElementById('ayudaWhatsappModal').classList.add('hidden');
      });

      document.getElementById('uploadArea').addEventListener('click', () => {
        document.getElementById('fotoPaquete').click();
      });

      document.getElementById('fotoPaquete').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          if (file.size > 5 * 1024 * 1024) {
            alert('âš ï¸ Imagen muy grande. MÃ¡ximo 5MB');
            e.target.value = '';
            return;
          }
          const reader = new FileReader();
          reader.onload = (event) => {
            document.getElementById('previewImg').src = event.target.result;
            document.getElementById('uploadPlaceholder').classList.add('hidden');
            document.getElementById('uploadPreview').classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        }
      });

      document.getElementById('removeFoto').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('fotoPaquete').value = '';
        document.getElementById('uploadPlaceholder').classList.remove('hidden');
        document.getElementById('uploadPreview').classList.add('hidden');
      });

      document.getElementById('nuevoEnvioForm').addEventListener('submit', procesarEnvio);

      document.getElementById('filtroTipo').addEventListener('change', renderizarSolicitudes);
document.getElementById('filtroEstado').addEventListener('change', renderizarSolicitudes);
document.getElementById('refrescarSolicitudes').addEventListener('click', cargarMisSolicitudes);


// Inicializar mÃ³dulo Solicitar Entrega cuando cargue el script
window.addEventListener('load', () => {
  if (typeof inicializarSolicitarEntrega === 'function') {
    inicializarSolicitarEntrega();
  }
});
    

    // SERVICE WORKER
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then((registration) => {
            window.secureLog('âœ… Service Worker registrado');

            setInterval(() => {
              registration.update();
            }, 5 * 60 * 1000);

            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              window.secureLog('ðŸ”„ Nueva versiÃ³n encontrada...');

              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  mostrarNotificacionActualizacion();
                }
              });
            });
          })
          .catch((error) => {
            window.secureLog('âŒ Error al registrar Service Worker:', error);
          });

        let refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (refreshing) return;
          refreshing = true;
          window.secureLog('ðŸ”„ Recargando para aplicar actualizaciÃ³n...');
          window.location.reload();
          });
        });
      }

    function mostrarNotificacionActualizacion() {
      const notif = document.createElement('div');
      notif.id = 'updateNotification';
      notif.innerHTML = `
        <div style="position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999; animation: slideDown 0.3s ease-out; max-width: 90%; width: 400px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="font-size: 24px;">ðŸŽ‰</div>
            <div style="flex: 1;">
              <p style="font-weight: bold; margin: 0; font-size: 15px;">Nueva versiÃ³n disponible</p>
              <p style="margin: 4px 0 0 0; font-size: 13px; opacity: 0.9;">Click para actualizar ahora</p>
            </div>
            <button onclick="actualizarAhora()" style="background: white; color: #059669; border: none; padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 13px;">
              Actualizar
            </button>
          </div>
        </div>
        <style>
          @keyframes slideDown {
            from { transform: translate(-50%, -100%); }
            to { transform: translate(-50%, 0); }
          }
        </style>
      `;
      document.body.appendChild(notif);

      setTimeout(() => {
        actualizarAhora();
      }, 10000);
    }

    function actualizarAhora() {
      const notif = document.getElementById('updateNotification');
      if (notif) notif.remove();

      if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage('SKIP_WAITING');
      }
    }

    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      mostrarBannerInstalacion();
    });

    function mostrarBannerInstalacion() {
      const banner = document.createElement('div');
      banner.id = 'installBanner';
      banner.innerHTML = `
        <div style="position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(135deg, #FF8C00 0%, #FF6B00 100%); color: white; padding: 16px; box-shadow: 0 -4px 12px rgba(0,0,0,0.15); z-index: 9999; animation: slideUp 0.3s ease-out;">
          <div style="max-width: 500px; margin: 0 auto; display: flex; align-items: center; gap: 12px;">
            <img src="https://res.cloudinary.com/drkaxsziu/image/upload/v1767871213/Somar_Express_2048_x_2048_px_18_x_18_in__20250623_221102_0000_o0bv7a.png" style="width: 48px; height: 48px; border-radius: 12px; background: white; padding: 4px;">
            <div style="flex: 1;">
              <p style="font-weight: bold; margin: 0; font-size: 16px;">Instalar Somar Express</p>
              <p style="margin: 0; font-size: 13px; opacity: 0.9;">Acceso rÃ¡pido desde tu pantalla de inicio</p>
            </div>
            <button onclick="instalarApp()" style="background: white; color: #FF8C00; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px;">
              Instalar
            </button>
            <button onclick="cerrarBanner()" style="background: transparent; color: white; border: 2px solid white; padding: 10px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px;">
              Ahora no
            </button>
          </div>
        </div>
        <style>
          @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
          }
        </style>
      `;
      document.body.appendChild(banner);
    }

    function instalarApp() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            window.secureLog('âœ… Usuario aceptÃ³ instalar');
          }
          deferredPrompt = null;
          cerrarBanner();
        });
      }
    }

    function cerrarBanner() {
      const banner = document.getElementById('installBanner');
      if (banner) {
        banner.style.animation = 'slideDown 0.3s ease-out';
        setTimeout(() => banner.remove(), 300);
      }
    }

    window.addEventListener('appinstalled', () => {
      window.secureLog('âœ… App instalada exitosamente');
      cerrarBanner();
    });
  </script>
  <!-- Script del mÃ³dulo Solicitar Entrega -->
  <script>
// ========================================
// MÓDULO: SOLICITAR ENTREGA (INTEGRADO)
// ========================================
// ========================================
// MÃ“DULO: SOLICITAR ENTREGA - JAVASCRIPT
// Para comercios-panel.html
// ========================================

// Variables globales del mÃ³dulo
let datosEntrega = {
  tipoServicio: 'TRASLADO_TIENDAS',
  ubicacionOrigen: null,
  ubicacionDestino: null,
  tarifa: 0
};

// ========================================
// INICIALIZACIÃ“N DEL MÃ“DULO
// ========================================
function inicializarSolicitarEntrega() {
  console.log('ðŸ“¦ Inicializando mÃ³dulo Solicitar Entrega...');
  
  // Event listeners para tipo de servicio
  document.querySelectorAll('input[name="tipoServicioEntrega"]').forEach(radio => {
    radio.addEventListener('change', cambiarTipoServicio);
  });

  // Event listeners para selects de tiendas
  document.getElementById('tiendaOrigen')?.addEventListener('change', calcularTarifaTraslado);
  document.getElementById('tiendaDestino')?.addEventListener('change', calcularTarifaTraslado);

  // Event listeners para recoger paquete
  document.getElementById('ubicacionRecogidaPaquete')?.addEventListener('input', debounce(validarUbicacionRecogida, 500));
  document.getElementById('destinoPaquete')?.addEventListener('change', manejarDestinoPaquete);

  // Event listeners para realizar compra
  document.getElementById('presupuestoCompra')?.addEventListener('input', calcularComisionCompra);
  document.getElementById('destinoCompra')?.addEventListener('change', calcularTarifaCompra);

  // Upload de foto
  document.getElementById('uploadAreaEntrega')?.addEventListener('click', () => {
    document.getElementById('fotoEntrega').click();
  });

  document.getElementById('fotoEntrega')?.addEventListener('change', manejarFotoEntrega);
  document.getElementById('removeFotoEntrega')?.addEventListener('click', (e) => {
    e.stopPropagation();
    removerFotoEntrega();
  });

  // Botones
  document.getElementById('cancelarSolicitudEntrega')?.addEventListener('click', cancelarSolicitudEntrega);
  document.getElementById('formSolicitarEntrega')?.addEventListener('submit', procesarSolicitudEntrega);
}

// ========================================
// CAMBIAR TIPO DE SERVICIO
// ========================================
function cambiarTipoServicio(e) {
  const tipoServicio = e.target.value;
  datosEntrega.tipoServicio = tipoServicio;
  
  // Ocultar todas las secciones
  document.getElementById('seccionTrasladoTiendas').classList.add('hidden');
  document.getElementById('seccionRecogerPaquete').classList.add('hidden');
  document.getElementById('seccionRealizarCompra').classList.add('hidden');
  document.getElementById('resumenTarifaEntrega').classList.add('hidden');
  
  // Mostrar secciÃ³n correspondiente
  switch(tipoServicio) {
    case 'TRASLADO_TIENDAS':
      document.getElementById('seccionTrasladoTiendas').classList.remove('hidden');
      break;
    case 'RECOGER_PAQUETE':
      document.getElementById('seccionRecogerPaquete').classList.remove('hidden');
      break;
    case 'REALIZAR_COMPRA':
      document.getElementById('seccionRealizarCompra').classList.remove('hidden');
      break;
  }
  
  // Reset tarifa
  datosEntrega.tarifa = 0;
  datosEntrega.ubicacionOrigen = null;
  datosEntrega.ubicacionDestino = null;
}

// ========================================
// CALCULAR TARIFA - TRASLADO ENTRE TIENDAS
// ========================================
async function calcularTarifaTraslado() {
  const origenSelect = document.getElementById('tiendaOrigen');
  const destinoSelect = document.getElementById('tiendaDestino');
  
  if (!origenSelect.value || !destinoSelect.value) {
    document.getElementById('resumenTarifaEntrega').classList.add('hidden');
    return;
  }
  
  if (origenSelect.value === destinoSelect.value) {
    alert('âš ï¸ La tienda de origen y destino no pueden ser la misma');
    destinoSelect.value = '';
    return;
  }
  
  const gpsOrigen = origenSelect.options[origenSelect.selectedIndex].dataset.gps;
  const gpsDestino = destinoSelect.options[destinoSelect.selectedIndex].dataset.gps;
  
  if (!gpsOrigen || !gpsDestino) {
    console.error('âŒ Falta GPS en las tiendas');
    return;
  }
  
  datosEntrega.ubicacionOrigen = gpsOrigen;
  datosEntrega.ubicacionDestino = gpsDestino;
  
  // Calcular tarifa usando la funciÃ³n existente
  const resultado = await calcularTarifaDelivery(gpsOrigen, gpsDestino);
  
  if (resultado) {
    mostrarResumenTarifa(resultado);
  }
}

// ========================================
// VALIDAR UBICACIÃ“N DE RECOGIDA (PAQUETE)
// ========================================
async function validarUbicacionRecogida() {
  const input = document.getElementById('ubicacionRecogidaPaquete').value.trim();
  
  if (input.length < 10) return;
  
  // Extraer coordenadas
  const coordMatch = input.match(/([0-9]{1,2}\.[0-9]+)\s*,\s*(-?[0-9]{1,3}\.[0-9]+)/);
  
  if (coordMatch) {
    const lat = parseFloat(coordMatch[1]);
    const lon = parseFloat(coordMatch[2]);
    
    if (lat >= 13 && lat <= 16 && lon >= -90 && lon <= -83) {
      datosEntrega.ubicacionOrigen = `${lat},${lon}`;
      console.log('âœ… UbicaciÃ³n de recogida vÃ¡lida:', datosEntrega.ubicacionOrigen);
      
      // Si ya hay destino, calcular tarifa
      const destinoSelect = document.getElementById('destinoPaquete');
      if (destinoSelect.value && destinoSelect.value !== 'otra') {
        calcularTarifaPaquete();
      }
    }
  }
}

// ========================================
// MANEJAR DESTINO DEL PAQUETE
// ========================================
function manejarDestinoPaquete() {
  const destinoSelect = document.getElementById('destinoPaquete');
  const otraUbicacion = document.getElementById('otraUbicacionDestino');
  
  if (destinoSelect.value === 'otra') {
    otraUbicacion.classList.remove('hidden');
  } else {
    otraUbicacion.classList.add('hidden');
    
    if (destinoSelect.value) {
      const gpsDestino = destinoSelect.options[destinoSelect.selectedIndex].dataset.gps;
      datosEntrega.ubicacionDestino = gpsDestino;
      calcularTarifaPaquete();
    }
  }
}

// ========================================
// CALCULAR TARIFA - RECOGER PAQUETE
// ========================================
async function calcularTarifaPaquete() {
  if (!datosEntrega.ubicacionOrigen || !datosEntrega.ubicacionDestino) {
    return;
  }
  
  const resultado = await calcularTarifaDelivery(datosEntrega.ubicacionOrigen, datosEntrega.ubicacionDestino);
  
  if (resultado) {
    mostrarResumenTarifa(resultado);
  }
}

// ========================================
// CALCULAR COMISIÃ“N DE COMPRA
// ========================================
function calcularComisionCompra() {
  const presupuesto = parseFloat(document.getElementById('presupuestoCompra').value) || 0;
  const comision = presupuesto * 0.10; // 10% de comisiÃ³n
  
  document.getElementById('comisionCompra').textContent = comision.toFixed(2);
  
  if (presupuesto > 0) {
    document.getElementById('comisionCompraRow').classList.remove('hidden');
  } else {
    document.getElementById('comisionCompraRow').classList.add('hidden');
  }
  
  // Recalcular total
  const tarifaBase = parseFloat(document.getElementById('tarifaBaseEntrega').textContent) || 0;
  const recargo = parseFloat(document.getElementById('tarifaRecargoNocturnoEntrega').textContent) || 0;
  const total = tarifaBase + recargo + comision;
  document.getElementById('tarifaTotalEntrega').textContent = total.toFixed(2);
}

// ========================================
// CALCULAR TARIFA - REALIZAR COMPRA
// ========================================
async function calcularTarifaCompra() {
  const ubicacionComercio = document.getElementById('ubicacionComercioCompra').value.trim();
  const destinoSelect = document.getElementById('destinoCompra');
  
  if (!ubicacionComercio || !destinoSelect.value) {
    return;
  }
  
  const gpsDestino = destinoSelect.options[destinoSelect.selectedIndex].dataset.gps;
  
  datosEntrega.ubicacionOrigen = ubicacionComercio;
  datosEntrega.ubicacionDestino = gpsDestino;
  
  const resultado = await calcularTarifaDelivery(ubicacionComercio, gpsDestino);
  
  if (resultado) {
    mostrarResumenTarifa(resultado);
    calcularComisionCompra(); // Actualizar con comisiÃ³n
  }
}

// ========================================
// MOSTRAR RESUMEN DE TARIFA
// ========================================
function mostrarResumenTarifa(resultado) {
  document.getElementById('distanciaKmEntrega').textContent = resultado.distanciaKm + ' km';
  document.getElementById('tarifaBaseEntrega').textContent = resultado.tarifaBase;
  document.getElementById('tarifaTotalEntrega').textContent = resultado.tarifaTotal;
  
  // Mostrar/ocultar recargo nocturno
  if (resultado.esModoNocturno) {
    document.getElementById('recargoNocturnoRowEntrega').classList.remove('hidden');
    document.getElementById('tarifaRecargoNocturnoEntrega').textContent = resultado.recargoNocturno;
    document.getElementById('modoNocturnoIndicadorEntrega').classList.remove('hidden');
  } else {
    document.getElementById('recargoNocturnoRowEntrega').classList.add('hidden');
    document.getElementById('modoNocturnoIndicadorEntrega').classList.add('hidden');
  }
  
  document.getElementById('resumenTarifaEntrega').classList.remove('hidden');
  
  datosEntrega.tarifa = parseFloat(resultado.tarifaTotal);
}

// ========================================
// MANEJO DE FOTO
// ========================================
function manejarFotoEntrega(e) {
  const file = e.target.files[0];
  if (file) {
    if (file.size > 5 * 1024 * 1024) {
      alert('âš ï¸ La imagen es muy grande. MÃ¡ximo 5MB.');
      e.target.value = '';
      return;
    }
    
    const reader = new FileReader();
    reader.onload = (event) => {
      document.getElementById('previewImgEntrega').src = event.target.result;
      document.getElementById('uploadPlaceholderEntrega').classList.add('hidden');
      document.getElementById('uploadPreviewEntrega').classList.remove('hidden');
    };
    reader.readAsDataURL(file);
  }
}

function removerFotoEntrega() {
  document.getElementById('fotoEntrega').value = '';
  document.getElementById('uploadPlaceholderEntrega').classList.remove('hidden');
  document.getElementById('uploadPreviewEntrega').classList.add('hidden');
}

// ========================================
// PROCESAR SOLICITUD DE ENTREGA
// ========================================
async function procesarSolicitudEntrega(e) {
  e.preventDefault();
  
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = 'Procesando...';
  submitBtn.disabled = true;
  
  try {
    // Subir foto si existe
    let fotoUrl = null;
    const fotoFile = document.getElementById('fotoEntrega').files[0];
    
    if (fotoFile) {
      submitBtn.textContent = 'Subiendo foto...';
      
      const formData = new FormData();
      formData.append('file', fotoFile);
      formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
      formData.append('cloud_name', CLOUDINARY_CLOUD_NAME);
      
      const cloudinaryResponse = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
        method: 'POST',
        body: formData
      });
      
      const cloudinaryData = await cloudinaryResponse.json();
      fotoUrl = cloudinaryData.secure_url;
    }
    
    // Recopilar datos segÃºn tipo de servicio
    const datos = {
      tipoServicio: datosEntrega.tipoServicio,
      idComercio: appData.comercio.id,
      nombreComercio: appData.comercio.nombre,
      telefonoComercio: appData.comercio.celular,
      descripcionContenido: document.getElementById('descripcionContenido').value,
      metodoPago: document.querySelector('input[name="metodoPagoEntrega"]:checked').value,
      notasAdicionales: document.getElementById('notasAdicionalesEntrega').value,
      fotoUrl: fotoUrl,
      ubicacionOrigen: datosEntrega.ubicacionOrigen,
      ubicacionDestino: datosEntrega.ubicacionDestino,
      tarifa: datosEntrega.tarifa,
      fechaSolicitud: new Date().toISOString()
    };
    
    // Datos especÃ­ficos segÃºn tipo
    switch(datosEntrega.tipoServicio) {
      case 'TRASLADO_TIENDAS':
        const origenSelect = document.getElementById('tiendaOrigen');
        const destinoSelect = document.getElementById('tiendaDestino');
        datos.tiendaOrigen = origenSelect.options[origenSelect.selectedIndex].text;
        datos.tiendaDestino = destinoSelect.options[destinoSelect.selectedIndex].text;
        break;
        
      case 'RECOGER_PAQUETE':
        datos.nombreContacto = document.getElementById('nombreContactoRecogida').value;
        datos.telefonoContacto = document.getElementById('telefonoContactoRecogida').value;
        const destinoPaq = document.getElementById('destinoPaquete');
        datos.destinoPaquete = destinoPaq.options[destinoPaq.selectedIndex].text;
        break;
        
      case 'REALIZAR_COMPRA':
        datos.nombreComercioCompra = document.getElementById('nombreComercioCompra').value;
        datos.listaProductos = document.getElementById('listaProductosCompra').value;
        datos.presupuesto = parseFloat(document.getElementById('presupuestoCompra').value);
        datos.comision = datos.presupuesto * 0.10;
        const destCompra = document.getElementById('destinoCompra');
        datos.destinoCompra = destCompra.options[destCompra.selectedIndex].text;
        break;
    }
    
    // Enviar a Google Sheets (ENVIO_COMERCIO)
    submitBtn.textContent = 'Enviando solicitud...';
    
    // Agregar campos adicionales para identificar como SOLICITUD
    datos.esEntrega = true; // Identificador para diferenciar de envÃ­os normales
    datos.estado = 'PENDIENTE_ASIGNACION';
    datos.tipoRegistro = 'SOLICITUD_ENTREGA'; // Campo para filtrar en Mis Solicitudes
    
    await fetch(SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'registrarEnvioComercio', // Usar la misma acciÃ³n para guardar en ENVIO_COMERCIO
        datos: datos
      })
    });
    
    // Ã‰xito
    alert('âœ… Solicitud de entrega registrada exitosamente. Pronto nos pondremos en contacto contigo.');
    
    // Limpiar formulario
    document.getElementById('formSolicitarEntrega').reset();
    document.getElementById('resumenTarifaEntrega').classList.add('hidden');
    removerFotoEntrega();
    datosEntrega = { tipoServicio: 'TRASLADO_TIENDAS', ubicacionOrigen: null, ubicacionDestino: null, tarifa: 0 };
    
    // Volver a tab de Mis Solicitudes (que mostrarÃ¡ tanto envÃ­os como entregas)
    document.getElementById('tabMisSolicitudes')?.click();
    
  } catch (error) {
    console.error('âŒ Error:', error);
    alert('âš ï¸ Error al procesar solicitud. Intenta nuevamente.');
  } finally {
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
  }
}

// ========================================
// CANCELAR SOLICITUD
// ========================================
function cancelarSolicitudEntrega() {
  if (confirm('Â¿EstÃ¡s seguro que deseas cancelar? Se perderÃ¡n los datos ingresados.')) {
    document.getElementById('formSolicitarEntrega').reset();
    document.getElementById('resumenTarifaEntrega').classList.add('hidden');
    removerFotoEntrega();
    datosEntrega = { tipoServicio: 'TRASLADO_TIENDAS', ubicacionOrigen: null, ubicacionDestino: null, tarifa: 0 };
    
    // Volver al tab principal
    document.getElementById('tabNuevoEnvio')?.click();
  }
}

// ========================================
// UTILIDADES
// ========================================
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// ========================================
// EXPORTAR FUNCIONES (si es necesario)
// ========================================
if (typeof window !== 'undefined') {
  window.inicializarSolicitarEntrega = inicializarSolicitarEntrega;
}
  </script>
</body>
</html>