<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#FF8C00">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Somar Comercios">
  
  <!-- Manifest -->
  <link rel="manifest" href="./manifest.json">
  
  <!-- Icons -->
  <link rel="icon" type="image/png" href="https://res.cloudinary.com/drkaxsziu/image/upload/v1767871213/Somar_Express_2048_x_2048_px_18_x_18_in__20250623_221102_0000_o0bv7a.png">
  <link rel="apple-touch-icon" href="https://res.cloudinary.com/drkaxsziu/image/upload/v1767871213/Somar_Express_2048_x_2048_px_18_x_18_in__20250623_221102_0000_o0bv7a.png">
  
  <title>Somar Express - Panel Comercios</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    #updateNotification {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .brand-orange { color: #FF8C00; }
    .bg-brand-orange { background-color: #FF8C00; }
    
    .loading {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #FFFFFF;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-small {
      border: 2px solid rgba(255, 140, 0, 0.3);
      border-top: 2px solid #FF8C00;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    
    .fade-in { animation: fadeIn 0.4s ease-in; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .scale-in { animation: scaleIn 0.2s ease-out; }
    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    #mapPreviewRecogida, #mapPreviewEntrega, #mapInteractive {
      height: 250px;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      z-index: 1;
    }

    #contentNuevoEnvio {
      position: relative;
      z-index: 10;
    }

    .bg-white.border-b.sticky {
      z-index: 40 !important;
    }

    header {
      z-index: 50 !important;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-PENDIENTE { background: #FEF3C7; color: #92400E; }
    .status-ACEPTADO { background: #DBEAFE; color: #1E40AF; }
    .status-EN_ESTABLECIMIENTO { background: #E0E7FF; color: #3730A3; }
    .status-PEDIDO_EN_CAMINO { background: #DDD6FE; color: #5B21B6; }
    .status-ENTREGANDO { background: #FCE7F3; color: #9F1239; }
    .status-FINALIZADO { background: #D1FAE5; color: #065F46; }
    .status-CANCELADO { background: #FEE2E2; color: #991B1B; }
  </style>

  <script src="./config-seguro-comercios.js"></script>
</head>
<body class="bg-gray-50">
  
  <!-- Header -->
  <header class="bg-white sticky top-0 z-50 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="https://res.cloudinary.com/drkaxsziu/image/upload/v1767871213/Somar_Express_2048_x_2048_px_18_x_18_in__20250623_221102_0000_o0bv7a.png" alt="Somar Express" class="w-12 h-12 object-contain">
          <div>
            <h1 class="font-bold text-lg">Panel Comercios</h1>
            <p class="text-xs text-gray-500" id="comercioName">Cargando...</p>
          </div>
        </div>
        
        <button id="logoutBtn" class="p-2 hover:bg-gray-100 rounded-full transition" title="Cerrar Sesi√≥n">
          <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Modal de Autenticaci√≥n -->
  <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-md w-full scale-in">
      <div class="p-6">
        <!-- Paso 1: Ingresar Tel√©fono -->
        <div id="authStep1">
          <div class="text-center mb-6">
            <img src="https://res.cloudinary.com/drkaxsziu/image/upload/v1767871213/Somar_Express_2048_x_2048_px_18_x_18_in__20250623_221102_0000_o0bv7a.png" alt="Somar Express" class="w-24 h-24 mx-auto mb-4">
            <h2 class="text-2xl font-bold mb-2">Panel de Comercios</h2>
            <p class="text-gray-600">Ingresa tu n√∫mero para gestionar tus env√≠os</p>
          </div>
          <form id="authPhoneForm">
            <div class="mb-4">
              <label class="block font-semibold mb-2 text-sm text-gray-700">N√∫mero de Celular</label>
              <input type="tel" id="authPhone" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition" placeholder="+504 9999-9999">
              <p class="text-xs text-gray-500 mt-1">Recibir√°s un c√≥digo por WhatsApp</p>
            </div>
            <button type="submit" class="w-full bg-brand-orange text-white py-4 rounded-xl font-bold hover:bg-orange-600 transition shadow-lg">Continuar</button>
          </form>
        </div>

        <!-- Paso 2: Verificar C√≥digo -->
        <div id="authStep2" class="hidden">
          <div class="text-center mb-6">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h2 class="text-2xl font-bold mb-2">C√≥digo Enviado</h2>
            <p class="text-gray-600">Revisa tu WhatsApp e ingresa el c√≥digo</p>
            <p class="text-sm text-gray-500 mt-2">Enviado a <span id="phoneDisplay" class="font-semibold"></span></p>
          </div>
          <form id="authCodeForm">
            <div class="mb-4">
              <input type="text" id="authCode" required maxlength="6" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-center text-2xl font-bold tracking-widest focus:border-brand-orange focus:outline-none transition" placeholder="000000">
            </div>
            <button type="submit" class="w-full bg-brand-orange text-white py-4 rounded-xl font-bold hover:bg-orange-600 transition shadow-lg mb-3">Verificar</button>
            <button type="button" id="resendCodeBtn" class="w-full text-brand-orange font-semibold hover:underline">Reenviar c√≥digo</button>
          </form>
        </div>

        <!-- Paso 3: Registro -->
        <div id="authStep3" class="hidden">
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold mb-2">Completa tu Registro</h2>
            <p class="text-gray-600">Necesitamos algunos datos de tu comercio</p>
          </div>
          <form id="authRegisterForm">
            <div class="mb-4">
              <label class="block font-semibold mb-2 text-sm text-gray-700">Nombre del Comercio *</label>
              <input type="text" id="authNombreComercio" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition" placeholder="Ej: Restaurante El Buen Sabor">
            </div>
            <div class="mb-4">
              <label class="block font-semibold mb-2 text-sm text-gray-700">Direcci√≥n del Comercio *</label>
              <textarea id="authDireccionComercio" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition" rows="2" placeholder="Colonia, calle, referencias..."></textarea>
            </div>
            <div class="mb-4">
              <label class="block font-semibold mb-2 text-sm text-gray-700">Ubicaci√≥n GPS del Comercio</label>
              <div class="flex gap-2">
                <input type="text" id="authUbicacionGPS" class="flex-1 border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition" placeholder="Lat, Lon" readonly>
                <button type="button" id="getLocationBtn" class="bg-blue-500 text-white px-4 rounded-xl font-semibold hover:bg-blue-600 transition">
                  üìç Obtener
                </button>
              </div>
            </div>
            <button type="submit" class="w-full bg-brand-orange text-white py-4 rounded-xl font-bold hover:bg-orange-600 transition shadow-lg">Registrar Comercio</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Vista Principal -->
  <div id="mainContent" class="hidden">
    <!-- Tabs -->
    <div class="bg-white border-b sticky top-16 z-40">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex gap-4">
          <button id="tabNuevoEnvio" class="tab-btn py-4 px-6 font-semibold border-b-2 border-brand-orange brand-orange">
            Nuevo Env√≠o
          </button>
          <button id="tabMisEnvios" class="tab-btn py-4 px-6 font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-800">
            Mis Env√≠os
          </button>
        </div>
      </div>
    </div>

    <!-- Contenido Tab: Nuevo Env√≠o -->
    <div id="contentNuevoEnvio" class="max-w-3xl mx-auto p-4">
      <form id="nuevoEnvioForm" class="bg-white rounded-2xl shadow-sm p-6 space-y-6">
        <h2 class="text-2xl font-bold mb-4">Crear Nuevo Env√≠o</h2>

        <!-- Tipo de Servicio -->
        <div>
          <label class="block font-semibold mb-3 text-gray-700">üì¶ Tipo de Servicio *</label>
          <div class="grid grid-cols-2 gap-3">
            <label class="relative cursor-pointer">
              <input type="radio" name="tipoServicio" value="SOLO_ENTREGA" class="peer sr-only" checked>
              <div class="border-2 border-gray-200 rounded-xl p-4 text-center peer-checked:border-brand-orange peer-checked:bg-orange-50 transition">
                <div class="text-3xl mb-2">üì¶</div>
                <div class="font-semibold">Solo Entrega</div>
                <div class="text-xs text-gray-500 mt-1">Env√≠o simple</div>
              </div>
            </label>
            <label class="relative cursor-pointer">
              <input type="radio" name="tipoServicio" value="PAGO_CONTRA_ENTREGA" class="peer sr-only">
              <div class="border-2 border-gray-200 rounded-xl p-4 text-center peer-checked:border-brand-orange peer-checked:bg-orange-50 transition">
                <div class="text-3xl mb-2">üí∞</div>
                <div class="font-semibold">Contra Entrega</div>
                <div class="text-xs text-gray-500 mt-1">Cobrar al entregar</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Quien Paga -->
        <div>
          <label class="block font-semibold mb-3 text-gray-700">üí≥ ¬øQui√©n paga el env√≠o? *</label>
          <div class="grid grid-cols-2 gap-3">
            <label class="relative cursor-pointer">
              <input type="radio" name="quienPaga" value="DESTINATARIO" class="peer sr-only" checked>
              <div class="border-2 border-gray-200 rounded-xl p-4 text-center peer-checked:border-brand-orange peer-checked:bg-orange-50 transition">
                <div class="text-2xl mb-1">üë§</div>
                <div class="font-semibold">Destinatario</div>
              </div>
            </label>
            <label class="relative cursor-pointer">
              <input type="radio" name="quienPaga" value="COMERCIO" class="peer sr-only">
              <div class="border-2 border-gray-200 rounded-xl p-4 text-center peer-checked:border-brand-orange peer-checked:bg-orange-50 transition">
                <div class="text-2xl mb-1">üè™</div>
                <div class="font-semibold">Yo (Comercio)</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Ubicaci√≥n de Recogida -->
        <div>
          <label class="block font-semibold mb-3 text-gray-700">üìç Ubicaci√≥n de Recogida *</label>
          <div class="flex gap-2 mb-2">
            <button type="button" id="usarUbicacionGuardada" class="flex-1 bg-blue-500 text-white py-3 rounded-xl font-semibold hover:bg-blue-600 transition">
              ‚úì Usar mi ubicaci√≥n guardada
            </button>
            <button type="button" id="cambiarRecogida" class="flex-1 border-2 border-gray-300 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-50 transition">
              üîÑ Cambiar
            </button>
          </div>
          <div id="recogidaCustom" class="hidden">
            <input type="text" id="linkRecogida" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition mb-2" placeholder="Pega link de Google Maps">
            <div id="mapPreviewRecogida" class="hidden mb-2"></div>
          </div>
          <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded-xl">
            <span class="font-semibold">üìå Actual:</span> <span id="direccionRecogidaDisplay">Cargando...</span>
          </div>
        </div>

        <!-- Ubicaci√≥n de Entrega -->
        <div>
          <label class="block font-semibold mb-3 text-gray-700 flex items-center justify-between">
            <span>üìç Ubicaci√≥n de Entrega *</span>
            <button type="button" id="abrirAyudaWhatsapp" class="text-xs text-blue-600 hover:text-blue-800 font-normal">
              ¬øC√≥mo obtenerla? üí°
            </button>
          </label>
          
          <div class="bg-blue-50 border-l-4 border-blue-400 p-3 mb-3 text-sm">
            <p class="font-semibold text-blue-800 mb-1">üì± ¬øTu cliente te mand√≥ la ubicaci√≥n por WhatsApp?</p>
            <p class="text-blue-700">Reenviala al Whatsapp +504 8912-5089 para que te genere las coordenadas facilmente.</p>
          </div>
          
          <div class="relative">
            <textarea id="linkEntrega" rows="2" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 pr-10 focus:border-brand-orange focus:outline-none transition resize-none" placeholder="Pega aqu√≠: Las coordenadas (14.0818, -87.2068)
"></textarea>
            <div id="linkEntregaStatus" class="hidden absolute right-3 top-3">
              <div class="loading-small"></div>
            </div>
          </div>
          
          <div id="ubicacionDetectada" class="hidden bg-green-50 border-2 border-green-300 rounded-xl p-3 mt-2 mb-2">
            <div class="flex items-start gap-2">
              <span class="text-xl">‚úÖ</span>
              <div class="flex-1">
                <p class="font-semibold text-green-800 text-sm">Ubicaci√≥n detectada correctamente</p>
                <p class="text-xs text-green-700 mt-1" id="coordenadasDetectadas"></p>
              </div>
            </div>
          </div>
          
          <div id="ubicacionError" class="hidden bg-red-50 border-2 border-red-300 rounded-xl p-3 mt-2 mb-2">
            <div class="flex items-start gap-2">
              <span class="text-xl">‚ö†Ô∏è</span>
              <div class="flex-1">
                <p class="font-semibold text-red-800 text-sm">No se detect√≥ ubicaci√≥n</p>
                <p class="text-xs text-red-700 mt-1">Verifica que hayas pegado el link completo o usa el mapa interactivo</p>
              </div>
            </div>
          </div>
          
          <div id="mapPreviewEntrega" class="hidden mb-2"></div>
          
          <div class="text-center my-3">
            <p class="text-xs text-gray-500 mb-2">- O -</p>
          </div>
          
          <button type="button" id="usarMapaInteractivo" class="w-full border-2 border-dashed border-gray-300 text-gray-600 py-3 rounded-xl font-semibold hover:border-brand-orange hover:text-brand-orange transition">
            üó∫Ô∏è Usar mapa interactivo
          </button>
        </div>

        <!-- Datos del Destinatario -->
        <div class="border-t pt-6">
          <h3 class="font-bold text-lg mb-4">üë§ Datos del Destinatario</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block font-semibold mb-2 text-sm text-gray-700">Nombre *</label>
              <input type="text" id="nombreDestinatario" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition" placeholder="Nombre completo">
            </div>
            <div>
              <label class="block font-semibold mb-2 text-sm text-gray-700">Tel√©fono *</label>
              <input type="tel" id="telefonoDestinatario" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition" placeholder="+504 9999-9999">
            </div>
          </div>
        </div>

        <!-- Descripci√≥n del Paquete -->
        <div>
          <label class="block font-semibold mb-2 text-sm text-gray-700">üì¶ Descripci√≥n del Paquete *</label>
          <textarea id="descripcionPaquete" required class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition" rows="3" placeholder="Ej: 2 cajas de pizza, 1 refresco de 2 litros"></textarea>
        </div>

        <!-- Foto del Paquete -->
        <div>
          <label class="block font-semibold mb-2 text-sm text-gray-700">üì∏ Foto del Paquete (Opcional)</label>
          <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-brand-orange transition cursor-pointer" id="uploadArea">
            <input type="file" id="fotoPaquete" accept="image/*" class="hidden">
            <div id="uploadPlaceholder">
              <div class="text-5xl mb-2">üì∏</div>
              <p class="text-sm text-gray-600 font-semibold">Click para subir foto</p>
              <p class="text-xs text-gray-500 mt-1">JPG, PNG (m√°x. 5MB)</p>
            </div>
            <div id="uploadPreview" class="hidden">
              <img id="previewImg" class="mx-auto max-h-40 rounded-lg mb-2">
              <p class="text-sm text-green-600 font-semibold">‚úì Foto cargada</p>
              <button type="button" id="removeFoto" class="text-xs text-red-500 hover:text-red-700 mt-2">Cambiar imagen</button>
            </div>
          </div>
        </div>

        <!-- Monto a Cobrar -->
        <div id="montoSection" class="hidden">
          <label class="block font-semibold mb-2 text-sm text-gray-700">üíµ Monto a Cobrar (Contra Entrega) *</label>
          <div class="relative">
            <span class="absolute left-4 top-1/2 transform -translate-y-1/2 font-bold text-gray-500">L.</span>
            <input type="number" id="montoCobrar" class="w-full border-2 border-gray-200 rounded-xl pl-10 pr-4 py-3 focus:border-brand-orange focus:outline-none transition" placeholder="0.00" step="0.01" min="0">
          </div>
        </div>

        <!-- Tipo de Pago del Env√≠o -->
        <div>
          <label class="block font-semibold mb-3 text-gray-700">üí≥ M√©todo de Pago del Env√≠o *</label>
          <div class="grid grid-cols-2 gap-3">
            <label class="relative cursor-pointer">
              <input type="radio" name="tipoPagoEnvio" value="EFECTIVO" class="peer sr-only" checked>
              <div class="border-2 border-gray-200 rounded-xl p-4 text-center peer-checked:border-brand-orange peer-checked:bg-orange-50 transition">
                <div class="text-2xl mb-1">üíµ</div>
                <div class="font-semibold">Efectivo</div>
              </div>
            </label>
            <label class="relative cursor-pointer">
              <input type="radio" name="tipoPagoEnvio" value="TRANSFERENCIA" class="peer sr-only">
              <div class="border-2 border-gray-200 rounded-xl p-4 text-center peer-checked:border-brand-orange peer-checked:bg-orange-50 transition">
                <div class="text-2xl mb-1">üè¶</div>
                <div class="font-semibold">Transferencia</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Notas Adicionales -->
        <div>
          <label class="block font-semibold mb-2 text-sm text-gray-700">üìù Notas Adicionales (Opcional)</label>
          <textarea id="notasAdicionales" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-brand-orange focus:outline-none transition" rows="2" placeholder="Ej: Tocar el timbre, dejar en porter√≠a, etc."></textarea>
        </div>

        <!-- Resumen de Tarifa -->
        <div id="tarifaResumen" class="hidden bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
          <h3 class="font-bold mb-3">üí∞ Estimado de Tarifa</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-700">Origen:</span>
              <span class="font-semibold" id="ciudadOrigen">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-700">Destino:</span>
              <span class="font-semibold" id="ciudadDestino">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-700">Distancia:</span>
              <span class="font-semibold" id="distanciaKm">-</span>
            </div>
            <div class="flex justify-between border-t pt-2 mt-2">
              <span class="text-gray-700">Tarifa Estimada:</span>
              <span class="font-bold text-lg brand-orange">L.<span id="tarifaTotal">0.00</span></span>
            </div>
          </div>
        </div>

        <button type="submit" class="w-full bg-brand-orange text-white py-4 rounded-xl font-bold text-lg hover:bg-orange-600 transition shadow-lg">
          üöÄ Crear Env√≠o
        </button>
      </form>
    </div>

    <!-- Contenido Tab: Mis Env√≠os -->
    <div id="contentMisEnvios" class="hidden max-w-5xl mx-auto p-4">
      <div class="mb-4 flex gap-2">
        <select id="filtroEstado" class="border-2 border-gray-200 rounded-xl px-4 py-2 focus:border-brand-orange focus:outline-none transition">
          <option value="">Todos los estados</option>
          <option value="PENDIENTE">Pendiente</option>
          <option value="ACEPTADO">Aceptado</option>
          <option value="EN_ESTABLECIMIENTO">En Establecimiento</option>
          <option value="PEDIDO_EN_CAMINO">Pedido en Camino</option>
          <option value="ENTREGANDO">Entregando</option>
          <option value="FINALIZADO">Finalizado</option>
          <option value="CANCELADO">Cancelado</option>
        </select>
        <button id="refrescarEnvios" class="bg-blue-500 text-white px-4 py-2 rounded-xl font-semibold hover:bg-blue-600 transition">
          üîÑ Refrescar
        </button>
      </div>
      <div id="listaEnvios" class="space-y-4">
        <div class="text-center py-12 text-gray-500">
          <p class="text-lg font-semibold">Cargando env√≠os...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Mapa Interactivo -->
  <div id="mapModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-2xl w-full scale-in">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Selecciona Ubicaci√≥n en el Mapa</h2>
          <button id="closeMapModal" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div id="mapInteractive"></div>
        <p class="text-sm text-gray-600 mt-3 mb-4">Haz clic en el mapa o arrastra el marcador</p>
        <button id="confirmarUbicacion" class="w-full bg-brand-orange text-white py-3 rounded-xl font-bold hover:bg-orange-600 transition">
          Confirmar Ubicaci√≥n
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Ayuda WhatsApp -->
  <div id="ayudaWhatsappModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[80] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-md w-full scale-in">
      <div class="p-6">
        <div class="text-center mb-4">
          <span class="text-5xl">üì±</span>
          <h2 class="text-xl font-bold mt-2">¬øC√≥mo obtener la ubicaci√≥n de WhatsApp?</h2>
        </div>
        
        <div class="space-y-4 text-sm">
          <div class="bg-green-50 p-3 rounded-lg">
            <p class="font-semibold text-green-800 mb-2">Si te mandaron el PIN de ubicaci√≥n:</p>
            <ol class="list-decimal list-inside text-green-700 space-y-1">
              <li>Toca el mensaje de ubicaci√≥n</li>
              <li>Se abrir√° Google Maps</li>
              <li>Toca y mant√©n sobre el pin rojo</li>
              <li>Aparecer√°n las coordenadas abajo</li>
              <li>Ej: 15.611781, -87.956879</li>
              <li>T√≥calas para copiarlas</li>
              <li>P√©galas en el formulario</li>
              <li>O manda la ubicaci√≥n al Whatsapp para que te genere las coordenadas</li>
            </ol>
          </div>
          
      
        </div>
        
        <button id="cerrarAyudaWhatsapp" class="w-full bg-brand-orange text-white py-3 rounded-xl font-bold hover:bg-orange-600 transition mt-4">
          Entendido
        </button>
      </div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = window.APP_CONFIG.apiEndpoint;
const CLOUDINARY_CLOUD_NAME = window.APP_CONFIG.cloudinary.cloudName;
const CLOUDINARY_UPLOAD_PRESET = window.APP_CONFIG.cloudinary.uploadPreset;

// Validar origen al cargar
if (!window.APP_SECURITY.validateOrigin()) {
  document.body.innerHTML = '<h1 style="text-align:center;margin-top:50px;">Acceso no autorizado</h1>';
  throw new Error('Invalid origin');
}

    let appData = {
      comercio: null,
      ubicacionRecogida: null,
      ubicacionEntrega: null,
      mapRecogida: null,
      mapEntrega: null,
      mapInteractive: null,
      markerInteractive: null,
      envios: []
    };

    // AUTENTICACI√ìN
    function verificarSesion() {
  const comercioGuardado = window.APP_SECURITY.getSecureSession('somarComercioUser');
  if (comercioGuardado) {
    try {
      appData.comercio = comercioGuardado;
          document.getElementById('authModal').classList.add('hidden');
          document.getElementById('mainContent').classList.remove('hidden');
          document.getElementById('comercioName').textContent = appData.comercio.nombre;
          document.getElementById('direccionRecogidaDisplay').textContent = appData.comercio.direccion;
          appData.ubicacionRecogida = appData.comercio.ubicacionGPS;
          return true;
        } catch (error) {
          localStorage.removeItem('somarComercioUser');
        }
      }
      return false;
    }

    async function enviarCodigoVerificacion(numero) {
      try {
        const submitBtn = document.querySelector('#authPhoneForm button[type="submit"]');
        submitBtn.textContent = 'Enviando...';
        submitBtn.disabled = true;

        await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'enviarCodigoVerificacionComercio',
            numero: numero
          })
        });

        appData.numeroTemporal = numero;
        document.getElementById('phoneDisplay').textContent = numero;
        document.getElementById('authStep1').classList.add('hidden');
        document.getElementById('authStep2').classList.remove('hidden');
        submitBtn.textContent = 'Continuar';
        submitBtn.disabled = false;
        alert('‚úÖ C√≥digo enviado por WhatsApp');
      } catch (error) {
        console.error('Error:', error);
        alert('‚ö†Ô∏è Error al enviar c√≥digo');
      }
    }

    async function verificarCodigoIngresado(codigo) {
      try {
        const submitBtn = document.querySelector('#authCodeForm button[type="submit"]');
        submitBtn.textContent = 'Verificando...';
        submitBtn.disabled = true;

        const url = `${SCRIPT_URL}?action=verificarCodigoComercio&numero=${encodeURIComponent(appData.numeroTemporal)}&codigo=${encodeURIComponent(codigo)}`;
        const response = await fetch(url);
        const result = await response.json();

        if (result.success) {
          if (result.comercioExiste) {
            appData.comercio = result.datosComercio;
            window.APP_SECURITY.saveSecureSession('somarComercioUser', appData.comercio);
            document.getElementById('authModal').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('comercioName').textContent = appData.comercio.nombre;
            document.getElementById('direccionRecogidaDisplay').textContent = appData.comercio.direccion;
            appData.ubicacionRecogida = appData.comercio.ubicacionGPS;
            alert(`¬°Bienvenido ${result.datosComercio.nombre}!`);
          } else {
            document.getElementById('authStep2').classList.add('hidden');
            document.getElementById('authStep3').classList.remove('hidden');
          }
        } else {
          alert(result.error || 'C√≥digo incorrecto');
          submitBtn.textContent = 'Verificar';
          submitBtn.disabled = false;
        }
      } catch (error) {
        console.error('Error:', error);
        alert('‚ö†Ô∏è Error al verificar c√≥digo');
      }
    }

    async function completarRegistroComercio(nombre, direccion, ubicacionGPS) {
      try {
        const submitBtn = document.querySelector('#authRegisterForm button[type="submit"]');
        submitBtn.textContent = 'Registrando...';
        submitBtn.disabled = true;

        const params = new URLSearchParams({
          action: 'completarRegistroComercio',
          celular: appData.numeroTemporal,
          nombre: nombre,
          direccion: direccion,
          ubicacionGPS: ubicacionGPS || ''
        });

        const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
        const result = await response.json();

        if (result.success) {
          appData.comercio = result.comercio;
          window.APP_SECURITY.saveSecureSession('somarComercioUser', appData.comercio);
          document.getElementById('authModal').classList.add('hidden');
          document.getElementById('mainContent').classList.remove('hidden');
          document.getElementById('comercioName').textContent = appData.comercio.nombre;
          document.getElementById('direccionRecogidaDisplay').textContent = appData.comercio.direccion;
          appData.ubicacionRecogida = appData.comercio.ubicacionGPS;
          alert('¬°Comercio registrado exitosamente!');
        } else {
          alert(result.error || 'Error al registrar');
          submitBtn.textContent = 'Registrar Comercio';
          submitBtn.disabled = false;
        }
      } catch (error) {
        console.error('Error:', error);
        alert('‚ö†Ô∏è Error al registrar');
      }
    }

    function cerrarSesion() {
      if (confirm('¬øCerrar sesi√≥n?')) {
        localStorage.removeItem('somarComercioUser');
        location.reload();
      }
    }

    // EXTRACCI√ìN DE COORDENADAS
    async function extraerCoordenadasDeLink(input) {
      try {
        input = input.trim();
        window.secureLog('üîç Procesando entrada:', input);

        const soloCoordMatch = input.match(/^\s*([0-9]{1,2}\.[0-9]+)\s*,\s*(-?[0-9]{1,3}\.[0-9]+)\s*$/);
        if (soloCoordMatch) {
          const lat = parseFloat(soloCoordMatch[1]);
          const lon = parseFloat(soloCoordMatch[2]);
          
          if (lat >= 13 && lat <= 16 && lon >= -90 && lon <= -83) {
            window.secureLog('‚úÖ Coordenadas directas detectadas');
            return { lat, lon, exito: true };
          }
        }

        if (input.includes('goo.gl') || input.includes('maps.app.goo.gl')) {
          window.secureLog('‚ö†Ô∏è Link acortado detectado');
          return { 
            exito: false, 
            error: 'LINK_ACORTADO',
            mensaje: 'Link acortado detectado.\n\nPor favor:\n1. Abre el link en Google Maps\n2. Espera que cargue\n3. Toca y mant√©n sobre la ubicaci√≥n\n4. Aparecer√°n las coordenadas abajo\n5. C√≥pialas y p√©galas aqu√≠\n\nO usa el mapa interactivo üó∫Ô∏è'
          };
        }

        return await extraerCoordenadasDeURL(input);

      } catch (error) {
        console.error('‚ùå Error:', error);
        return { exito: false, error: error.toString() };
      }
    }

    async function extraerCoordenadasDeURL(url) {
      const qMatch = url.match(/[?&]q=([0-9.-]+),([0-9.-]+)/);
      if (qMatch) {
        window.secureLog('‚úÖ Coordenadas encontradas (q)');
        return { lat: parseFloat(qMatch[1]), lon: parseFloat(qMatch[2]), exito: true };
      }

      const atMatch = url.match(/@([0-9.-]+),([0-9.-]+)/);
      if (atMatch) {
        window.secureLog('‚úÖ Coordenadas encontradas (@)');
        return { lat: parseFloat(atMatch[1]), lon: parseFloat(atMatch[2]), exito: true };
      }

      const placeMatch = url.match(/\/place\/.*?@([0-9.-]+),([0-9.-]+)/);
      if (placeMatch) {
        window.secureLog('‚úÖ Coordenadas encontradas (place)');
        return { lat: parseFloat(placeMatch[1]), lon: parseFloat(placeMatch[2]), exito: true };
      }

      const coordMatch = url.match(/([0-9]{1,2}\.[0-9]{4,})[,\s]+(-?[0-9]{1,3}\.[0-9]{4,})/);
      if (coordMatch) {
        const lat = parseFloat(coordMatch[1]);
        const lon = parseFloat(coordMatch[2]);
        
        if (lat >= 13 && lat <= 16 && lon >= -90 && lon <= -83) {
          window.secureLog('‚úÖ Coordenadas encontradas (patr√≥n general)');
          return { lat, lon, exito: true };
        }
      }

      window.secureLog('‚ùå No se encontraron coordenadas en la URL');
      return { exito: false, error: 'No se detectaron coordenadas v√°lidas' };
    }

    // C√ÅLCULO DE TARIFAS
    function calcularDistanciaHaversine(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function obtenerCiudad(lat, lon) {
      const ciudades = [
        { nombre: 'Choloma', lat: 15.61, lon: -87.95, radio: 0.10 },
        { nombre: 'San Pedro Sula', lat: 15.50, lon: -88.03, radio: 0.15 },
        { nombre: 'Tegucigalpa', lat: 14.08, lon: -87.21, radio: 0.15 },
        { nombre: 'La Ceiba', lat: 15.78, lon: -86.80, radio: 0.10 },
        { nombre: 'El Progreso', lat: 15.40, lon: -87.80, radio: 0.08 },
        { nombre: 'Comayagua', lat: 14.45, lon: -87.64, radio: 0.10 },
        { nombre: 'Puerto Cort√©s', lat: 15.85, lon: -87.94, radio: 0.08 },
        { nombre: 'Villanueva', lat: 15.32, lon: -88.00, radio: 0.08 },
        { nombre: 'La Lima', lat: 15.43, lon: -87.91, radio: 0.06 },
        { nombre: 'Choluteca', lat: 13.30, lon: -87.19, radio: 0.10 },
        { nombre: 'Danl√≠', lat: 14.03, lon: -86.58, radio: 0.08 },
        { nombre: 'Juticalpa', lat: 14.66, lon: -86.22, radio: 0.08 },
        { nombre: 'Santa Rosa de Cop√°n', lat: 14.77, lon: -88.78, radio: 0.08 },
        { nombre: 'Siguatepeque', lat: 14.60, lon: -87.84, radio: 0.08 },
        { nombre: 'Tocoa', lat: 15.66, lon: -86.00, radio: 0.08 },
        { nombre: 'Tela', lat: 15.78, lon: -87.46, radio: 0.08 }
      ];

      for (const ciudad of ciudades) {
        const distancia = Math.sqrt(Math.pow(lat - ciudad.lat, 2) + Math.pow(lon - ciudad.lon, 2));
        if (distancia < ciudad.radio) {
          window.secureLog(`‚úÖ Ciudad detectada: ${ciudad.nombre}`);
          return ciudad.nombre;
        }
      }

      if (lat >= 15.3 && lat <= 16.0 && lon >= -88.5 && lon <= -87.3) return 'Cort√©s';
      else if (lat >= 13.8 && lat <= 14.4 && lon >= -87.5 && lon <= -86.8) return 'Francisco Moraz√°n';
      else if (lat >= 15.5 && lat <= 16.0 && lon >= -87.0 && lon <= -86.0) return 'Atl√°ntida';
      else if (lat >= 14.4 && lat <= 15.0 && lon >= -86.8 && lon <= -86.0) return 'Olancho';
      else if (lat >= 13.0 && lat <= 13.8 && lon >= -87.5 && lon <= -86.8) return 'Choluteca';

      window.secureLog('‚ö†Ô∏è Ciudad no detectada, usando gen√©rico');
      return 'Honduras';
    }

    async function calcularDistanciaOSRM(lat1, lon1, lat2, lon2) {
      try {
        const url = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=false`;
        window.secureLog('üåê Consultando OSRM...');
        const response = await fetch(url);
        if (!response.ok) throw new Error('OSRM failed');
        const data = await response.json();
        if (data.code !== 'Ok' || !data.routes || data.routes.length === 0) throw new Error('No route');
        const distanciaKm = data.routes[0].distance / 1000;
        window.secureLog(`‚úÖ OSRM: ${distanciaKm.toFixed(2)} km por carretera`);
        return distanciaKm;
      } catch (error) {
        console.error('‚ùå OSRM error:', error);
        throw error;
      }
    }

    function calcularTarifaCholoma(km) {
      const tabla = [
        { min: 0, max: 3, tarifa: 50 },
        { min: 3, max: 7, tarifa: 75 },
        { min: 7, max: 9, tarifa: 90 },
        { min: 9, max: 11, tarifa: 105 },
        { min: 11, max: 13, tarifa: 120 },
        { min: 13, max: 15, tarifa: 135 }
      ];
      for (const r of tabla) {
        if (km >= r.min && km < r.max) {
          window.secureLog(`‚úÖ Choloma ${r.min}-${r.max}km: L.${r.tarifa}`);
          return r.tarifa;
        }
      }
      const calc = 30 + (km * 6.8);
      const redondeado = Math.round(calc / 5) * 5;
      window.secureLog(`üìä Choloma fuera de tabla: ${calc.toFixed(2)} ‚Üí L.${redondeado}`);
      return redondeado;
    }

    function calcularTarifaOtrasCiudades(km) {
      const tabla = [
        { min: 0, max: 11, tarifa: 125 },
        { min: 11, max: 13, tarifa: 135 },
        { min: 13, max: 15, tarifa: 150 },
        { min: 15, max: 17, tarifa: 165 },
        { min: 17, max: 19, tarifa: 180 },
        { min: 19, max: 21, tarifa: 195 }
      ];
      for (const r of tabla) {
        if (km >= r.min && km < r.max) {
          window.secureLog(`‚úÖ Otras ${r.min}-${r.max}km: L.${r.tarifa}`);
          return r.tarifa;
        }
      }
      const calc = 40 + (km * 7.5);
      const redondeado = Math.round(calc / 5) * 5;
      window.secureLog(`üìä Otras fuera de tabla: ${calc.toFixed(2)} ‚Üí L.${redondeado}`);
      return redondeado;
    }

    async function calcularTarifa(ubicacionRecogida, ubicacionEntrega) {
      if (!ubicacionRecogida || !ubicacionEntrega) {
        window.secureLog('‚ö†Ô∏è Faltan ubicaciones');
        return;
      }

      try {
        const [lat1, lon1] = ubicacionRecogida.split(',').map(Number);
        const [lat2, lon2] = ubicacionEntrega.split(',').map(Number);

        if (isNaN(lat1) || isNaN(lon1) || isNaN(lat2) || isNaN(lon2)) {
          console.error('‚ùå Coordenadas inv√°lidas');
          return;
        }

        const ciudadOrigen = obtenerCiudad(lat1, lon1);
        const ciudadDestino = obtenerCiudad(lat2, lon2);

        window.secureLog(`üìç Origen: ${ciudadOrigen}, Destino: ${ciudadDestino}`);

        let distanciaKm;
        try {
          distanciaKm = await calcularDistanciaOSRM(lat1, lon1, lat2, lon2);
        } catch (error) {
          console.warn('‚ö†Ô∏è OSRM fallback a Haversine');
          distanciaKm = calcularDistanciaHaversine(lat1, lon1, lat2, lon2);
        }

        const esCholoma = ciudadOrigen.toLowerCase().includes('choloma') && 
                          ciudadDestino.toLowerCase().includes('choloma');

        const tarifaTotal = esCholoma ? 
          calcularTarifaCholoma(distanciaKm) : 
          calcularTarifaOtrasCiudades(distanciaKm);

        document.getElementById('ciudadOrigen').textContent = ciudadOrigen;
        document.getElementById('ciudadDestino').textContent = ciudadDestino;
        document.getElementById('distanciaKm').textContent = distanciaKm.toFixed(2) + ' km';
        document.getElementById('tarifaTotal').textContent = tarifaTotal.toFixed(2);
        document.getElementById('tarifaResumen').classList.remove('hidden');

        window.secureLog(`‚úÖ Tarifa: L.${tarifaTotal.toFixed(2)}`);
      } catch (error) {
        console.error('‚ùå Error:', error);
      }
    }

    // MAPAS
    function mostrarMapaPreview(lat, lon, containerId) {
      window.secureLog(`üó∫Ô∏è Mostrando mapa preview en ${containerId}:`, lat, lon);
      
      const container = document.getElementById(containerId);
      if (!container) {
        console.error('‚ùå Contenedor no encontrado:', containerId);
        return;
      }

      if (containerId === 'mapPreviewRecogida' && appData.mapRecogida) {
        try {
          appData.mapRecogida.off();
          appData.mapRecogida.remove();
        } catch (error) {
          window.secureLog('‚ö†Ô∏è Error limpiando mapa recogida:', error);
        }
        appData.mapRecogida = null;
      }
      
      if (containerId === 'mapPreviewEntrega' && appData.mapEntrega) {
        try {
          appData.mapEntrega.off();
          appData.mapEntrega.remove();
        } catch (error) {
          window.secureLog('‚ö†Ô∏è Error limpiando mapa entrega:', error);
        }
        appData.mapEntrega = null;
      }
      
      container.innerHTML = '';
      container.className = '';
      
      const newContainer = document.createElement('div');
      newContainer.id = containerId;
      newContainer.style.height = '250px';
      newContainer.style.borderRadius = '12px';
      newContainer.style.overflow = 'hidden';
      newContainer.style.position = 'relative';
      newContainer.className = 'mb-2';
      
      container.parentNode.replaceChild(newContainer, container);
      newContainer.classList.remove('hidden');
      
      setTimeout(() => {
        try {
          const map = L.map(containerId, {
            center: [lat, lon],
            zoom: 15,
            zoomControl: true,
            scrollWheelZoom: false
          });
          
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap',
            maxZoom: 18
          }).addTo(map);
          
          L.marker([lat, lon]).addTo(map);
          
          if (containerId === 'mapPreviewRecogida') {
            appData.mapRecogida = map;
          } else if (containerId === 'mapPreviewEntrega') {
            appData.mapEntrega = map;
          }
          
          setTimeout(() => map.invalidateSize(), 150);
          window.secureLog(`‚úÖ Mapa ${containerId} creado`);
          
        } catch (error) {
          console.error(`‚ùå Error creando mapa ${containerId}:`, error);
        }
      }, 250);
    }

    function inicializarMapaInteractivo() {
      window.secureLog('üó∫Ô∏è Inicializando mapa interactivo...');
      
      const modal = document.getElementById('mapModal');
      const container = document.getElementById('mapInteractive');

      if (appData.mapInteractive) {
        try {
          appData.mapInteractive.off();
          appData.mapInteractive.remove();
        } catch (error) {
          window.secureLog('‚ö†Ô∏è Error limpiando mapa:', error);
        }
        appData.mapInteractive = null;
        appData.markerInteractive = null;
      }

      container.innerHTML = '';
      container.className = '';
      
      const newContainer = document.createElement('div');
      newContainer.id = 'mapInteractive';
      newContainer.style.height = '250px';
      newContainer.style.borderRadius = '12px';
      newContainer.style.overflow = 'hidden';
      newContainer.style.position = 'relative';
      
      container.parentNode.replaceChild(newContainer, container);
      modal.classList.remove('hidden');

      setTimeout(() => {
        try {
          let centerLat = 15.5;
          let centerLon = -88.0;
          
          if (appData.comercio && appData.comercio.ubicacionGPS) {
            const coords = appData.comercio.ubicacionGPS.split(',');
            if (coords.length === 2) {
              centerLat = parseFloat(coords[0]);
              centerLon = parseFloat(coords[1]);
            }
          }
          
          appData.mapInteractive = L.map('mapInteractive', {
            center: [centerLat, centerLon],
            zoom: 13,
            zoomControl: true
          });
          
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap',
            maxZoom: 18
          }).addTo(appData.mapInteractive);

          appData.markerInteractive = L.marker([centerLat, centerLon], { 
            draggable: true 
          }).addTo(appData.mapInteractive);

          appData.mapInteractive.on('click', (e) => {
            appData.markerInteractive.setLatLng(e.latlng);
          });
          
          setTimeout(() => appData.mapInteractive.invalidateSize(), 200);
          window.secureLog('‚úÖ Mapa interactivo creado');
        } catch (error) {
          console.error('‚ùå Error:', error);
          alert('Error al cargar el mapa. Intenta de nuevo.');
        }
      }, 250);
    }

    // GESTI√ìN DE ENV√çOS
    async function cargarMisEnvios() {
      try {
        const url = `${SCRIPT_URL}?action=obtenerEnviosComercio&idComercio=${appData.comercio.id}`;
        const response = await fetch(url);
        const result = await response.json();

        if (result.success) {
          appData.envios = result.envios;
          renderizarEnvios();
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function renderizarEnvios() {
      const container = document.getElementById('listaEnvios');
      const filtroEstado = document.getElementById('filtroEstado').value;

      let enviosFiltrados = appData.envios;
      if (filtroEstado) {
        enviosFiltrados = enviosFiltrados.filter(e => e.estado === filtroEstado);
      }

      if (enviosFiltrados.length === 0) {
        container.innerHTML = '<div class="text-center py-12 text-gray-500"><p>No hay env√≠os para mostrar</p></div>';
        return;
      }

      container.innerHTML = enviosFiltrados.map(envio => `
        <div class="bg-white rounded-xl shadow-sm p-4 hover:shadow-md transition">
          <div class="flex justify-between items-start mb-3">
            <div>
              <p class="font-bold text-lg">Env√≠o #${envio.id}</p>
              <p class="text-sm text-gray-600">${new Date(envio.fecha).toLocaleString('es-HN')}</p>
            </div>
            <span class="status-badge status-${envio.estado}">${envio.estado.replace(/_/g, ' ')}</span>
          </div>
          <div class="grid grid-cols-2 gap-2 text-sm mb-3">
            <div>
              <p class="text-gray-500">Origen:</p>
              <p class="font-semibold">${envio.ciudadOrigen || '-'}</p>
            </div>
            <div>
              <p class="text-gray-500">Destino:</p>
              <p class="font-semibold">${envio.ciudadDestino || '-'}</p>
            </div>
            <div>
              <p class="text-gray-500">Destinatario:</p>
              <p class="font-semibold">${envio.nombreDestinatario}</p>
            </div>
            <div>
              <p class="text-gray-500">Tipo:</p>
              <p class="font-semibold">${envio.tipoServicio === 'PAGO_CONTRA_ENTREGA' ? 'üí∞ Contra Entrega' : 'üì¶ Solo Entrega'}</p>
            </div>
          </div>
          ${envio.delivery ? `<p class="text-sm text-blue-600">üöö Delivery: ${envio.delivery}</p>` : ''}
          <p class="text-sm text-gray-600 mt-2">${envio.descripcionPaquete}</p>
        </div>
      `).join('');
    }

    async function procesarEnvio(e) {
      e.preventDefault();

      if (!appData.ubicacionRecogida) {
        alert('‚ö†Ô∏è Debes configurar la ubicaci√≥n de recogida');
        return;
      }

      if (!appData.ubicacionEntrega) {
        alert('‚ö†Ô∏è Debes pegar la ubicaci√≥n de entrega que te mand√≥ tu cliente por WhatsApp');
        document.getElementById('linkEntrega').focus();
        return;
      }

      const tipoServicio = document.querySelector('input[name="tipoServicio"]:checked').value;
      const quienPaga = document.querySelector('input[name="quienPaga"]:checked').value;
      const nombreDestinatario = document.getElementById('nombreDestinatario').value;
      const telefonoDestinatario = document.getElementById('telefonoDestinatario').value;
      const descripcionPaquete = document.getElementById('descripcionPaquete').value;
      const montoCobrar = tipoServicio === 'PAGO_CONTRA_ENTREGA' ? document.getElementById('montoCobrar').value : 0;
      const tipoPagoEnvio = document.querySelector('input[name="tipoPagoEnvio"]:checked').value;
      const notasAdicionales = document.getElementById('notasAdicionales').value;

      let fotoUrl = null;
      const fotoFile = document.getElementById('fotoPaquete').files[0];

      const submitBtn = document.querySelector('#nuevoEnvioForm button[type="submit"]');
      submitBtn.textContent = 'Procesando...';
      submitBtn.disabled = true;

      if (fotoFile) {
        try {
          const formData = new FormData();
          formData.append('file', fotoFile);
          formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
          formData.append('cloud_name', CLOUDINARY_CLOUD_NAME);

          const cloudinaryResponse = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
            method: 'POST',
            body: formData
          });

          const cloudinaryData = await cloudinaryResponse.json();
          fotoUrl = cloudinaryData.secure_url;
        } catch (error) {
          console.error('Error subiendo foto:', error);
        }
      }

      const datos = {
        idComercio: appData.comercio.id,
        nombreComercio: appData.comercio.nombre,
        telefonoComercio: appData.comercio.celular,
        tipoServicio,
        quienPaga,
        ubicacionRecogidaGPS: appData.ubicacionRecogida,
        ubicacionEntregaGPS: appData.ubicacionEntrega,
        nombreDestinatario,
        telefonoDestinatario,
        descripcionPaquete,
        montoCobrar,
        tipoPagoEnvio,
        notasAdicionales,
        fotoUrl,
        ciudadOrigen: document.getElementById('ciudadOrigen').textContent,
        ciudadDestino: document.getElementById('ciudadDestino').textContent,
        distanciaKm: document.getElementById('distanciaKm').textContent,
        tarifaEstimada: document.getElementById('tarifaTotal').textContent
      };

      try {
        await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'registrarEnvioComercio',
            datos: datos
          })
        });

        alert('‚úÖ Env√≠o registrado exitosamente');
        document.getElementById('nuevoEnvioForm').reset();
        document.getElementById('tarifaResumen').classList.add('hidden');
        document.getElementById('uploadPlaceholder').classList.remove('hidden');
        document.getElementById('uploadPreview').classList.add('hidden');
        document.getElementById('ubicacionDetectada').classList.add('hidden');
        submitBtn.textContent = 'üöÄ Crear Env√≠o';
        submitBtn.disabled = false;
        appData.ubicacionEntrega = null;

        document.getElementById('tabMisEnvios').click();
      } catch (error) {
        console.error('Error:', error);
        alert('‚ö†Ô∏è Error al registrar env√≠o');
        submitBtn.textContent = 'üöÄ Crear Env√≠o';
        submitBtn.disabled = false;
      }
    }

    // EVENT LISTENERS
    window.addEventListener('DOMContentLoaded', () => {
      verificarSesion();

      document.getElementById('authPhoneForm').addEventListener('submit', (e) => {
        e.preventDefault();
        enviarCodigoVerificacion(document.getElementById('authPhone').value);
      });

      document.getElementById('authCodeForm').addEventListener('submit', (e) => {
        e.preventDefault();
        verificarCodigoIngresado(document.getElementById('authCode').value);
      });

      document.getElementById('authRegisterForm').addEventListener('submit', (e) => {
        e.preventDefault();
        completarRegistroComercio(
          document.getElementById('authNombreComercio').value,
          document.getElementById('authDireccionComercio').value,
          document.getElementById('authUbicacionGPS').value
        );
      });

      document.getElementById('resendCodeBtn').addEventListener('click', () => {
        enviarCodigoVerificacion(appData.numeroTemporal);
      });

      document.getElementById('authCode').addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
      });

      document.getElementById('getLocationBtn').addEventListener('click', () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const gps = `${position.coords.latitude},${position.coords.longitude}`;
              document.getElementById('authUbicacionGPS').value = gps;
            },
            () => alert('No se pudo obtener ubicaci√≥n')
          );
        }
      });

      document.getElementById('logoutBtn').addEventListener('click', cerrarSesion);

      document.getElementById('tabNuevoEnvio').addEventListener('click', () => {
        document.getElementById('tabNuevoEnvio').classList.add('border-brand-orange', 'brand-orange');
        document.getElementById('tabNuevoEnvio').classList.remove('border-transparent', 'text-gray-500');
        document.getElementById('tabMisEnvios').classList.remove('border-brand-orange', 'brand-orange');
        document.getElementById('tabMisEnvios').classList.add('border-transparent', 'text-gray-500');
        document.getElementById('contentNuevoEnvio').classList.remove('hidden');
        document.getElementById('contentMisEnvios').classList.add('hidden');
      });

      document.getElementById('tabMisEnvios').addEventListener('click', () => {
        document.getElementById('tabMisEnvios').classList.add('border-brand-orange', 'brand-orange');
        document.getElementById('tabMisEnvios').classList.remove('border-transparent', 'text-gray-500');
        document.getElementById('tabNuevoEnvio').classList.remove('border-brand-orange', 'brand-orange');
        document.getElementById('tabNuevoEnvio').classList.add('border-transparent', 'text-gray-500');
        document.getElementById('contentMisEnvios').classList.remove('hidden');
        document.getElementById('contentNuevoEnvio').classList.add('hidden');
        cargarMisEnvios();
      });

      document.querySelectorAll('input[name="tipoServicio"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          const montoSection = document.getElementById('montoSection');
          if (e.target.value === 'PAGO_CONTRA_ENTREGA') {
            montoSection.classList.remove('hidden');
            document.getElementById('montoCobrar').setAttribute('required', 'required');
          } else {
            montoSection.classList.add('hidden');
            document.getElementById('montoCobrar').removeAttribute('required');
          }
        });
      });

      document.getElementById('cambiarRecogida').addEventListener('click', () => {
        document.getElementById('recogidaCustom').classList.remove('hidden');
      });

      document.getElementById('usarUbicacionGuardada').addEventListener('click', () => {
        document.getElementById('recogidaCustom').classList.add('hidden');
        appData.ubicacionRecogida = appData.comercio.ubicacionGPS;
      });

      let linkEntregaTimeout;
      document.getElementById('linkEntrega').addEventListener('input', (e) => {
        clearTimeout(linkEntregaTimeout);
        
        const statusIndicator = document.getElementById('linkEntregaStatus');
        const input = e.target.value.trim();
        
        document.getElementById('ubicacionDetectada').classList.add('hidden');
        document.getElementById('ubicacionError').classList.add('hidden');
        
        if (input.length > 5) {
          statusIndicator.classList.remove('hidden');
          
          linkEntregaTimeout = setTimeout(async () => {
            window.secureLog('üîç Procesando entrada:', input);
            const resultado = await extraerCoordenadasDeLink(input);
            statusIndicator.classList.add('hidden');
            
            if (resultado.exito) {
              window.secureLog('‚úÖ Coordenadas extra√≠das:', resultado.lat, resultado.lon);
              appData.ubicacionEntrega = `${resultado.lat},${resultado.lon}`;
              
              document.getElementById('ubicacionDetectada').classList.remove('hidden');
              document.getElementById('coordenadasDetectadas').textContent = `Lat: ${resultado.lat.toFixed(6)}, Lon: ${resultado.lon.toFixed(6)}`;
              
              mostrarMapaPreview(resultado.lat, resultado.lon, 'mapPreviewEntrega');
              await calcularTarifa(appData.ubicacionRecogida, appData.ubicacionEntrega);
              
              e.target.classList.remove('border-red-500');
              e.target.classList.add('border-green-500');
              
            } else {
              window.secureLog('‚ùå No se encontraron coordenadas');
              e.target.classList.remove('border-green-500');
              e.target.classList.add('border-red-500');
              
              document.getElementById('ubicacionError').classList.remove('hidden');
              
              if (resultado.error === 'LINK_ACORTADO') {
                alert(resultado.mensaje);
              }
            }
          }, 1000);
        } else {
          statusIndicator.classList.add('hidden');
          e.target.classList.remove('border-green-500', 'border-red-500');
        }
      });

      document.getElementById('usarMapaInteractivo').addEventListener('click', () => {
        inicializarMapaInteractivo();
      });

      document.getElementById('closeMapModal').addEventListener('click', () => {
        const modal = document.getElementById('mapModal');
        modal.classList.add('hidden');
        
        if (appData.mapInteractive) {
          try {
            appData.mapInteractive.off();
            appData.mapInteractive.remove();
          } catch (error) {}
          appData.mapInteractive = null;
          appData.markerInteractive = null;
        }
        
        const container = document.getElementById('mapInteractive');
        if (container) {
          container.innerHTML = '';
          container.className = '';
        }
      });

      document.getElementById('confirmarUbicacion').addEventListener('click', () => {
        if (!appData.markerInteractive) {
          alert('‚ö†Ô∏è Error: No se ha seleccionado ubicaci√≥n');
          return;
        }

        const latlng = appData.markerInteractive.getLatLng();
        appData.ubicacionEntrega = `${latlng.lat},${latlng.lng}`;
        
        document.getElementById('ubicacionDetectada').classList.remove('hidden');
        document.getElementById('coordenadasDetectadas').textContent = `Lat: ${latlng.lat.toFixed(6)}, Lon: ${latlng.lng.toFixed(6)}`;
        
        document.getElementById('mapModal').classList.add('hidden');
        
        if (appData.mapInteractive) {
          try {
            appData.mapInteractive.off();
            appData.mapInteractive.remove();
          } catch (error) {}
          appData.mapInteractive = null;
          appData.markerInteractive = null;
        }
        
        const container = document.getElementById('mapInteractive');
        if (container) {
          container.innerHTML = '';
          container.className = '';
        }
        
        setTimeout(() => {
          mostrarMapaPreview(latlng.lat, latlng.lng, 'mapPreviewEntrega');
          setTimeout(async () => {
            await calcularTarifa(appData.ubicacionRecogida, appData.ubicacionEntrega);
          }, 500);
        }, 300);
      });

      document.getElementById('abrirAyudaWhatsapp').addEventListener('click', () => {
        document.getElementById('ayudaWhatsappModal').classList.remove('hidden');
      });

      document.getElementById('cerrarAyudaWhatsapp').addEventListener('click', () => {
        document.getElementById('ayudaWhatsappModal').classList.add('hidden');
      });

      document.getElementById('uploadArea').addEventListener('click', () => {
        document.getElementById('fotoPaquete').click();
      });

      document.getElementById('fotoPaquete').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          if (file.size > 5 * 1024 * 1024) {
            alert('‚ö†Ô∏è Imagen muy grande. M√°ximo 5MB');
            e.target.value = '';
            return;
          }
          const reader = new FileReader();
          reader.onload = (event) => {
            document.getElementById('previewImg').src = event.target.result;
            document.getElementById('uploadPlaceholder').classList.add('hidden');
            document.getElementById('uploadPreview').classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        }
      });

      document.getElementById('removeFoto').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('fotoPaquete').value = '';
        document.getElementById('uploadPlaceholder').classList.remove('hidden');
        document.getElementById('uploadPreview').classList.add('hidden');
      });

      document.getElementById('nuevoEnvioForm').addEventListener('submit', procesarEnvio);

      document.getElementById('filtroEstado').addEventListener('change', renderizarEnvios);
      document.getElementById('refrescarEnvios').addEventListener('click', cargarMisEnvios);
    });

    // SERVICE WORKER
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then((registration) => {
            window.secureLog('‚úÖ Service Worker registrado');

            setInterval(() => {
              registration.update();
            }, 5 * 60 * 1000);

            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              window.secureLog('üîÑ Nueva versi√≥n encontrada...');

              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  mostrarNotificacionActualizacion();
                }
              });
            });
          })
          .catch((error) => {
            window.secureLog('‚ùå Error al registrar Service Worker:', error);
          });

        let refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (refreshing) return;
          refreshing = true;
          window.secureLog('üîÑ Recargando para aplicar actualizaci√≥n...');
          window.location.reload();
        });
      });
    }

    function mostrarNotificacionActualizacion() {
      const notif = document.createElement('div');
      notif.id = 'updateNotification';
      notif.innerHTML = `
        <div style="position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999; animation: slideDown 0.3s ease-out; max-width: 90%; width: 400px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="font-size: 24px;">üéâ</div>
            <div style="flex: 1;">
              <p style="font-weight: bold; margin: 0; font-size: 15px;">Nueva versi√≥n disponible</p>
              <p style="margin: 4px 0 0 0; font-size: 13px; opacity: 0.9;">Click para actualizar ahora</p>
            </div>
            <button onclick="actualizarAhora()" style="background: white; color: #059669; border: none; padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 13px;">
              Actualizar
            </button>
          </div>
        </div>
        <style>
          @keyframes slideDown {
            from { transform: translate(-50%, -100%); }
            to { transform: translate(-50%, 0); }
          }
        </style>
      `;
      document.body.appendChild(notif);

      setTimeout(() => {
        actualizarAhora();
      }, 10000);
    }

    function actualizarAhora() {
      const notif = document.getElementById('updateNotification');
      if (notif) notif.remove();

      if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage('SKIP_WAITING');
      }
    }

    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      mostrarBannerInstalacion();
    });

    function mostrarBannerInstalacion() {
      const banner = document.createElement('div');
      banner.id = 'installBanner';
      banner.innerHTML = `
        <div style="position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(135deg, #FF8C00 0%, #FF6B00 100%); color: white; padding: 16px; box-shadow: 0 -4px 12px rgba(0,0,0,0.15); z-index: 9999; animation: slideUp 0.3s ease-out;">
          <div style="max-width: 500px; margin: 0 auto; display: flex; align-items: center; gap: 12px;">
            <img src="https://res.cloudinary.com/drkaxsziu/image/upload/v1767871213/Somar_Express_2048_x_2048_px_18_x_18_in__20250623_221102_0000_o0bv7a.png" style="width: 48px; height: 48px; border-radius: 12px; background: white; padding: 4px;">
            <div style="flex: 1;">
              <p style="font-weight: bold; margin: 0; font-size: 16px;">Instalar Somar Express</p>
              <p style="margin: 0; font-size: 13px; opacity: 0.9;">Acceso r√°pido desde tu pantalla de inicio</p>
            </div>
            <button onclick="instalarApp()" style="background: white; color: #FF8C00; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px;">
              Instalar
            </button>
            <button onclick="cerrarBanner()" style="background: transparent; color: white; border: 2px solid white; padding: 10px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px;">
              Ahora no
            </button>
          </div>
        </div>
        <style>
          @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
          }
        </style>
      `;
      document.body.appendChild(banner);
    }

    function instalarApp() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            window.secureLog('‚úÖ Usuario acept√≥ instalar');
          }
          deferredPrompt = null;
          cerrarBanner();
        });
      }
    }

    function cerrarBanner() {
      const banner = document.getElementById('installBanner');
      if (banner) {
        banner.style.animation = 'slideDown 0.3s ease-out';
        setTimeout(() => banner.remove(), 300);
      }
    }

    window.addEventListener('appinstalled', () => {
      window.secureLog('‚úÖ App instalada exitosamente');
      cerrarBanner();
    });
  </script>
</body>
</html>